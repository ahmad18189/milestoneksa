[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Project",
  "enabled": 1,
  "modified": "2025-11-09 17:15:12.871588",
  "module": "Milestoneksa",
  "name": "Project Task Tab",
  "script": "frappe.ui.form.on(\"Project\", {\n\trefresh(frm) {\n\t\t// Add custom button in form toolbar\n\t\tif (!frm.is_new()) {\n\t\t\tfrm.add_custom_button(__(\"Sync Tasks\"), () => {\n\t\t\t\tfrm.events.render_project_task_tab(frm);\n\t\t\t\tfrappe.show_alert({\n\t\t\t\t\tmessage: __(\"Task table synced\"),\n\t\t\t\t\tindicator: \"green\"\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t\t\n\t\tfrm.events.render_project_task_tab(frm);\n\t},\n\n\tafter_save(frm) {\n\t\tfrm.events.render_project_task_tab(frm);\n\t},\n\n\trender_project_task_tab(frm) {\n\t\tconsole.log(\"Project Task Tab: Starting render...\");\n\t\tconsole.log(\"Project Task Tab: Fields available:\", Object.keys(frm.fields_dict));\n\t\t\n\t\tconst field = frm.fields_dict.custom_project_tasks_html;\n\t\tif (!field) {\n\t\t\tconsole.warn(\"Project Task Tab: HTML field 'custom_project_tasks_html' not found!\");\n\t\t\tfrappe.msgprint({\n\t\t\t\ttitle: __(\"Debug Info\"),\n\t\t\t\tmessage: __(\"Custom field 'custom_project_tasks_html' not found. Please reload the page.\"),\n\t\t\t\tindicator: \"orange\"\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log(\"Project Task Tab: Field found, rendering table...\");\n\n\t\tconst wrapper = field.$wrapper;\n\t\twrapper.empty().addClass(\"project-task-tab-wrapper\").css({\n\t\t\t\"padding\": \"15px\",\n\t\t\t\"background\": \"#ffffff\",\n\t\t\t\"min-height\": \"400px\"\n\t\t});\n\n\t\tif (frm.is_new()) {\n\t\t\twrapper.append(\n\t\t\t\t$(\"<div class='text-muted small mt-2'>\")\n\t\t\t\t\t.text(__(\"Save the project to manage tasks from this tab.\"))\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\tconst header = $(`\n\t\t\t<style>\n\t\t\t\t.project-tasks-header {\n\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\tpadding: 20px;\n\t\t\t\t\tborder-radius: 8px;\n\t\t\t\t\tcolor: white;\n\t\t\t\t\tmargin: 0 0 20px 0;\n\t\t\t\t\tbox-shadow: 0 2px 8px rgba(0,0,0,0.1);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-tasks-header .h6 {\n\t\t\t\t\tcolor: white;\n\t\t\t\t\tfont-size: 18px;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t\tmargin-bottom: 5px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-tasks-header small {\n\t\t\t\t\tcolor: rgba(255,255,255,0.9);\n\t\t\t\t\tfont-size: 12px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-tasks-header .btn {\n\t\t\t\t\tborder: 1px solid rgba(255,255,255,0.3);\n\t\t\t\t\tbackground: rgba(255,255,255,0.15);\n\t\t\t\t\tcolor: white;\n\t\t\t\t\tbackdrop-filter: blur(10px);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-tasks-header .btn:hover {\n\t\t\t\t\tbackground: rgba(255,255,255,0.25);\n\t\t\t\t\tborder-color: rgba(255,255,255,0.5);\n\t\t\t\t\ttransform: translateY(-2px);\n\t\t\t\t\tbox-shadow: 0 4px 12px rgba(0,0,0,0.2);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-tasks-header .btn-primary {\n\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\tborder: 1px solid white;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-tasks-header .btn-primary:hover {\n\t\t\t\t\tbackground: linear-gradient(135deg, #764ba2 0%, #667eea 100%);\n\t\t\t\t\tbox-shadow: 0 4px 12px rgba(255,255,255,0.3);\n\t\t\t\t}\n\t\t\t</style>\n\t\t\t<div class=\"d-flex justify-content-between align-items-center mb-3 project-tasks-header\">\n\t\t\t\t<div>\n\t\t\t\t\t<div class=\"h6 mb-0\">üìã ${__(\"Project Tasks\")}</div>\n\t\t\t\t\t<small>Click cells with üìù to edit inline. Parent tasks (blue) auto-update from children.</small>\n\t\t\t\t</div>\n\t\t\t\t<div>\n\t\t\t\t\t<button class=\"btn btn-sm btn-light me-1\" data-role=\"expand-all\" title=\"${__(\"Expand All\")}\">\n\t\t\t\t\t\t‚ñº ${__(\"Expand\")}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class=\"btn btn-sm btn-light me-2\" data-role=\"collapse-all\" title=\"${__(\"Collapse All\")}\">\n\t\t\t\t\t\t‚ñ∂ ${__(\"Collapse\")}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class=\"btn btn-sm btn-success\" data-role=\"recalc-parents\">\n\t\t\t\t\t\t<svg class=\"icon icon-sm\"><use href=\"#icon-refresh\"></use></svg> ${__(\"Recalc Parents\")}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class=\"btn btn-sm btn-primary\" data-role=\"add-task\">\n\t\t\t\t\t\t<svg class=\"icon icon-sm\"><use href=\"#icon-add\"></use></svg> ${__(\"Add Task\")}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class=\"btn btn-sm btn-secondary\" data-role=\"refresh-tasks\">\n\t\t\t\t\t\t<svg class=\"icon icon-sm\"><use href=\"#icon-refresh\"></use></svg> ${__(\"Refresh\")}\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`);\n\n\t\tconst tableWrapper = $(`\n\t\t\t<style>\n\t\t\t\t/* Enhanced table wrapper */\n\t\t\t\t.project-task-tab-wrapper {\n\t\t\t\t\tfont-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Table styling */\n\t\t\t\t.project-task-table-wrapper {\n\t\t\t\t\tborder-radius: 8px;\n\t\t\t\t\toverflow: visible;\n\t\t\t\t\tbox-shadow: 0 1px 3px rgba(0,0,0,0.08);\n\t\t\t\t\tmargin: 0;\n\t\t\t\t\twidth: 100%;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.table-responsive {\n\t\t\t\t\tborder-radius: 8px;\n\t\t\t\t\tborder: 1px solid #dee2e6;\n\t\t\t\t\toverflow-x: auto;\n\t\t\t\t\toverflow-y: auto;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .table {\n\t\t\t\t\tmargin-bottom: 0;\n\t\t\t\t\tfont-size: 13px;\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\ttable-layout: auto;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Header styling */\n\t\t\t\t.project-task-table-wrapper .table thead th {\n\t\t\t\t\tbackground: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);\n\t\t\t\t\tborder-bottom: 2px solid #dee2e6;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t\tfont-size: 12px;\n\t\t\t\t\ttext-transform: uppercase;\n\t\t\t\t\tletter-spacing: 0.3px;\n\t\t\t\t\tcolor: #495057;\n\t\t\t\t\tpadding: 12px 8px;\n\t\t\t\t\twhite-space: nowrap;\n\t\t\t\t\tposition: sticky;\n\t\t\t\t\ttop: 0;\n\t\t\t\t\tz-index: 10;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Editable cells */\n\t\t\t\t.editable-cell { \n\t\t\t\t\tcursor: pointer; \n\t\t\t\t\tbackground-color: #f8f9fa;\n\t\t\t\t\ttransition: all 0.2s ease;\n\t\t\t\t\tposition: relative;\n\t\t\t\t\tborder-left: 2px solid transparent;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.editable-cell:hover { \n\t\t\t\t\tbackground-color: #fff3cd;\n\t\t\t\t\tborder-left-color: #ffc107;\n\t\t\t\t\tbox-shadow: inset 0 0 0 1px #ffc107;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.editable-cell::after {\n\t\t\t\t\tcontent: '‚úé';\n\t\t\t\t\tposition: absolute;\n\t\t\t\t\tright: 4px;\n\t\t\t\t\ttop: 50%;\n\t\t\t\t\ttransform: translateY(-50%);\n\t\t\t\t\topacity: 0;\n\t\t\t\t\tfont-size: 10px;\n\t\t\t\t\tcolor: #6c757d;\n\t\t\t\t\ttransition: opacity 0.2s;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.editable-cell:hover::after {\n\t\t\t\t\topacity: 0.6;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Parent task rows */\n\t\t\t\t.table-primary { \n\t\t\t\t\tbackground: linear-gradient(90deg, #e7f3ff 0%, #d4e9ff 100%) !important;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t\tborder-left: 4px solid #0d6efd !important;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.table-primary:hover {\n\t\t\t\t\tbackground: linear-gradient(90deg, #d4e9ff 0%, #c5e2ff 100%) !important;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Row hover effects */\n\t\t\t\t.project-task-table-wrapper .table tbody tr {\n\t\t\t\t\ttransition: all 0.15s ease;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .table tbody tr:hover {\n\t\t\t\t\tbackground-color: #f8f9fa;\n\t\t\t\t\ttransform: scale(1.001);\n\t\t\t\t\tbox-shadow: 0 2px 4px rgba(0,0,0,0.06);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Task subject link */\n\t\t\t\t.task-subject a {\n\t\t\t\t\tcolor: #0d6efd;\n\t\t\t\t\ttext-decoration: none;\n\t\t\t\t\ttransition: color 0.2s;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.task-subject a:hover {\n\t\t\t\t\tcolor: #0a58ca;\n\t\t\t\t\ttext-decoration: underline;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.table-primary .task-subject a {\n\t\t\t\t\tcolor: #084298;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* WBS badge */\n\t\t\t\t.project-task-table-wrapper td:nth-child(2) {\n\t\t\t\t\tfont-family: 'Courier New', monospace;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t\tcolor: #6c757d;\n\t\t\t\t\tfont-size: 11px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Status badges */\n\t\t\t\t.project-task-table-wrapper td[data-field=\"status\"] {\n\t\t\t\t\tfont-weight: 500;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Actual date columns - green highlight */\n\t\t\t\t.project-task-table-wrapper td[data-field=\"custom_actual_start_date\"],\n\t\t\t\t.project-task-table-wrapper td[data-field=\"custom_actual_end_date\"] {\n\t\t\t\t\tbackground-color: #f0f9ff !important;\n\t\t\t\t\tborder-left: 2px solid #17a2b8;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper td[data-field=\"custom_actual_start_date\"]:hover,\n\t\t\t\t.project-task-table-wrapper td[data-field=\"custom_actual_end_date\"]:hover {\n\t\t\t\t\tbackground-color: #d1f2eb !important;\n\t\t\t\t\tborder-left-color: #20c997;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Action buttons */\n\t\t\t\t.project-task-table-wrapper .btn-link {\n\t\t\t\t\tcolor: #6c757d;\n\t\t\t\t\ttransition: all 0.2s;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .btn-link:hover {\n\t\t\t\t\tcolor: #0d6efd;\n\t\t\t\t\ttransform: scale(1.2);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Collapse triangle */\n\t\t\t\t.collapse-triangle {\n\t\t\t\t\tdisplay: inline-block;\n\t\t\t\t\twidth: 16px;\n\t\t\t\t\theight: 16px;\n\t\t\t\t\tline-height: 16px;\n\t\t\t\t\ttext-align: center;\n\t\t\t\t\tcursor: pointer;\n\t\t\t\t\tuser-select: none;\n\t\t\t\t\ttransition: transform 0.3s ease;\n\t\t\t\t\tcolor: #0d6efd;\n\t\t\t\t\tfont-weight: bold;\n\t\t\t\t\tmargin-right: 8px;\n\t\t\t\t\tborder-radius: 3px;\n\t\t\t\t\tbackground: rgba(13, 110, 253, 0.1);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.collapse-triangle:hover {\n\t\t\t\t\tbackground: rgba(13, 110, 253, 0.2);\n\t\t\t\t\ttransform: scale(1.2);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.collapse-triangle.collapsed {\n\t\t\t\t\ttransform: rotate(-90deg);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.collapse-triangle.collapsed:hover {\n\t\t\t\t\ttransform: rotate(-90deg) scale(1.2);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Child task rows */\n\t\t\t\t.child-task.hidden-by-collapse {\n\t\t\t\t\tdisplay: none !important;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Loading and empty states */\n\t\t\t\t[data-role=\"loading\"], [data-role=\"empty\"] {\n\t\t\t\t\tpadding: 40px;\n\t\t\t\t\ttext-align: center;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Input fields in edit mode */\n\t\t\t\t.editable-cell .form-control-sm {\n\t\t\t\t\tborder: 2px solid #0d6efd;\n\t\t\t\t\tbox-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Button styling */\n\t\t\t\t.project-task-tab-wrapper .btn {\n\t\t\t\t\ttransition: all 0.2s ease;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-tab-wrapper .btn:hover {\n\t\t\t\t\ttransform: translateY(-1px);\n\t\t\t\t\tbox-shadow: 0 2px 4px rgba(0,0,0,0.15);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Responsive table scroll */\n\t\t\t\t.project-task-table-wrapper .table-responsive {\n\t\t\t\t\tmax-height: 70vh;\n\t\t\t\t\toverflow-x: auto;\n\t\t\t\t\toverflow-y: auto;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .table-responsive::-webkit-scrollbar {\n\t\t\t\t\twidth: 10px;\n\t\t\t\t\theight: 10px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .table-responsive::-webkit-scrollbar-track {\n\t\t\t\t\tbackground: #f1f1f1;\n\t\t\t\t\tborder-radius: 5px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .table-responsive::-webkit-scrollbar-thumb {\n\t\t\t\t\tbackground: linear-gradient(180deg, #888 0%, #666 100%);\n\t\t\t\t\tborder-radius: 5px;\n\t\t\t\t\tborder: 2px solid #f1f1f1;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .table-responsive::-webkit-scrollbar-thumb:hover {\n\t\t\t\t\tbackground: linear-gradient(180deg, #555 0%, #333 100%);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Ensure content isn't cut off */\n\t\t\t\t.project-task-tab-wrapper {\n\t\t\t\t\toverflow: visible !important;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .table td,\n\t\t\t\t.project-task-table-wrapper .table th {\n\t\t\t\t\tpadding: 10px 8px;\n\t\t\t\t\tvertical-align: middle;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Minimum column widths */\n\t\t\t\t.project-task-table-wrapper th:nth-child(1) { min-width: 220px; }\n\t\t\t\t.project-task-table-wrapper th:nth-child(2) { min-width: 60px; }\n\t\t\t\t.project-task-table-wrapper th:nth-child(3) { min-width: 120px; }\n\t\t\t\t.project-task-table-wrapper th:nth-child(4) { min-width: 100px; }\n\t\t\t\t.project-task-table-wrapper th:nth-child(5) { min-width: 130px; }\n\t\t\t\t.project-task-table-wrapper th:nth-child(6) { min-width: 130px; }\n\t\t\t\t.project-task-table-wrapper th:nth-child(9) { min-width: 130px; }\n\t\t\t\t.project-task-table-wrapper th:nth-child(10) { min-width: 130px; }\n\t\t\t</style>\n\t\t\t<div class=\"table-responsive project-task-table-wrapper\">\n\t\t\t\t<table class=\"table table-bordered table-sm align-middle mb-0\">\n\t\t\t\t\t<thead class=\"table-light\">\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<th style=\"min-width: 220px;\">\n\t\t\t\t\t\t\t\t<svg class=\"icon icon-sm text-primary\"><use href=\"#icon-task\"></use></svg>\n\t\t\t\t\t\t\t\t${__(\"Task Name\")}\n\t\t\t\t\t\t\t</th>\n\t\t\t\t\t\t\t<th><span class=\"badge bg-secondary\">WBS</span></th>\n\t\t\t\t\t\t\t<th>üìä ${__(\"Status\")} üìù</th>\n\t\t\t\t\t\t\t<th>‚≠ê ${__(\"Priority\")} üìù</th>\n\t\t\t\t\t\t\t<th>üìÖ ${__(\"Planned Start\")} üìù</th>\n\t\t\t\t\t\t\t<th>üèÅ ${__(\"Planned Finish\")} üìù</th>\n\t\t\t\t\t\t\t<th>‚è±Ô∏è ${__(\"Duration\")}</th>\n\t\t\t\t\t\t\t<th>üïê ${__(\"Planned Hours\")} üìù</th>\n\t\t\t\t\t\t\t<th style=\"background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); font-weight: 700;\">\n\t\t\t\t\t\t\t\t‚úÖ ${__(\"Actual Start\")} üìù\n\t\t\t\t\t\t\t</th>\n\t\t\t\t\t\t\t<th style=\"background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); font-weight: 700;\">\n\t\t\t\t\t\t\t\t‚úÖ ${__(\"Actual End\")} üìù\n\t\t\t\t\t\t\t</th>\n\t\t\t\t\t\t\t<th>üìè ${__(\"Actual Duration\")}</th>\n\t\t\t\t\t\t\t<th>‚è∞ ${__(\"Actual Hours\")}</th>\n\t\t\t\t\t\t\t<th>üí∞ ${__(\"Actual Cost\")}</th>\n\t\t\t\t\t\t\t<th class=\"text-center\" style=\"min-width: 90px;\">‚öôÔ∏è ${__(\"Actions\")}</th>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</thead>\n\t\t\t\t\t<tbody></tbody>\n\t\t\t\t</table>\n\t\t\t</div>\n\t\t`);\n\n\t\tconst emptyState = $(`\n\t\t\t<div class=\"alert alert-light border mt-3 mb-0 d-none text-center\" data-role=\"empty\" style=\"padding: 60px; border-radius: 8px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);\">\n\t\t\t\t<svg class=\"icon icon-xl text-muted mb-3\" style=\"width: 64px; height: 64px;\"><use href=\"#icon-task\"></use></svg>\n\t\t\t\t<h5 class=\"text-muted\">${__(\"No Tasks Yet\")}</h5>\n\t\t\t\t<p class=\"text-muted mb-0\">${__(\"Use the Add Task button above to create your first task for this project.\")}</p>\n\t\t\t</div>\n\t\t`);\n\n\t\tconst loadingState = $(`\n\t\t\t<div class=\"text-center mt-5 mb-5\" data-role=\"loading\">\n\t\t\t\t<div class=\"spinner-border text-primary\" role=\"status\" style=\"width: 3rem; height: 3rem;\">\n\t\t\t\t\t<span class=\"visually-hidden\">${__(\"Loading...\")}</span>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"mt-3 text-muted\">${__(\"Loading tasks...\")}</div>\n\t\t\t</div>\n\t\t`);\n\n\t\twrapper.append(header, tableWrapper, emptyState, loadingState);\n\n\t\theader.find(\"[data-role='add-task']\").on(\"click\", () => {\n\t\t\tfrm.events.open_project_task_dialog(frm);\n\t\t});\n\n\t\theader.find(\"[data-role='refresh-tasks']\").on(\"click\", () => {\n\t\t\tfrm.events.load_project_tasks(frm);\n\t\t});\n\t\t\n\t\theader.find(\"[data-role='recalc-parents']\").on(\"click\", () => {\n\t\t\tfrm.events.recalculate_all_parents(frm);\n\t\t});\n\t\t\n\t\theader.find(\"[data-role='expand-all']\").on(\"click\", () => {\n\t\t\tfrm.events.expand_all_tasks(frm);\n\t\t});\n\t\t\n\t\theader.find(\"[data-role='collapse-all']\").on(\"click\", () => {\n\t\t\tfrm.events.collapse_all_tasks(frm);\n\t\t});\n\n\t\tfrm.events.load_project_tasks(frm);\n\t},\n\t\n\texpand_all_tasks(frm) {\n\t\tconst taskMap = frm.__task_hierarchy || {};\n\t\tObject.values(taskMap).forEach(task => {\n\t\t\tif (task.children && task.children.length > 0) {\n\t\t\t\ttask.expanded = true;\n\t\t\t\tconst row = $(`tr[data-task=\"${task.name}\"]`);\n\t\t\t\tconst triangle = row.find(\".collapse-triangle\");\n\t\t\t\ttriangle.removeClass(\"collapsed\");\n\t\t\t\trow.removeClass(\"collapsed\");\n\t\t\t}\n\t\t});\n\t\t$(\"tr.child-task\").removeClass(\"hidden-by-collapse\").fadeIn(200);\n\t\tfrappe.show_alert({ message: __(\"All tasks expanded\"), indicator: \"blue\" }, 2);\n\t},\n\t\n\tcollapse_all_tasks(frm) {\n\t\tconst taskMap = frm.__task_hierarchy || {};\n\t\tObject.values(taskMap).forEach(task => {\n\t\t\tif (task.children && task.children.length > 0) {\n\t\t\t\ttask.expanded = false;\n\t\t\t\tconst row = $(`tr[data-task=\"${task.name}\"]`);\n\t\t\t\tconst triangle = row.find(\".collapse-triangle\");\n\t\t\t\ttriangle.addClass(\"collapsed\");\n\t\t\t\trow.addClass(\"collapsed\");\n\t\t\t}\n\t\t});\n\t\t$(\"tr.child-task\").addClass(\"hidden-by-collapse\").fadeOut(200);\n\t\tfrappe.show_alert({ message: __(\"All tasks collapsed\"), indicator: \"blue\" }, 2);\n\t},\n\t\n\trecalculate_all_parents(frm) {\n\t\tfrappe.call({\n\t\t\tmethod: \"milestoneksa.api.project_tasks.recalculate_all_project_parents\",\n\t\t\targs: { project: frm.doc.name },\n\t\t\tfreeze: true,\n\t\t\tfreeze_message: __(\"Recalculating parent tasks...\"),\n\t\t\tcallback: (r) => {\n\t\t\t\tif (r.message) {\n\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\tmessage: __(`Updated ${r.message.updated_count} parent tasks`),\n\t\t\t\t\t\tindicator: \"green\"\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tfrm.events.load_project_tasks(frm);\n\t\t\t},\n\t\t});\n\t},\n\n\tload_project_tasks(frm) {\n\t\tconst field = frm.fields_dict.custom_project_tasks_html;\n\t\tif (!field) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst wrapper = field.$wrapper;\n\t\tconst tableBody = wrapper.find(\"tbody\");\n\t\tconst emptyState = wrapper.find(\"[data-role='empty']\");\n\t\tconst loadingState = wrapper.find(\"[data-role='loading']\");\n\n\t\ttableBody.empty();\n\t\temptyState.addClass(\"d-none\");\n\t\tloadingState.removeClass(\"d-none\");\n\n\t\tconsole.log(\"Project Task Tab: Fetching tasks for project:\", frm.doc.name);\n\t\t\n\t\tfrappe.call({\n\t\t\tmethod: \"milestoneksa.api.project_tasks.get_project_tasks\",\n\t\t\targs: { project: frm.doc.name },\n\t\t\tcallback: (r) => {\n\t\t\t\tloadingState.addClass(\"d-none\");\n\t\t\t\tconsole.log(\"Project Task Tab: API response:\", r);\n\n\t\t\t\tif (!r || !r.message) {\n\t\t\t\t\tconsole.warn(\"Project Task Tab: No data returned\");\n\t\t\t\t\temptyState.removeClass(\"d-none\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst { tasks = [], currency, status_options = [], priority_options = [] } = r.message;\n\n\t\t\t\tfrm.__project_task_meta = {\n\t\t\t\t\tcurrency,\n\t\t\t\t\tstatus_options,\n\t\t\t\t\tpriority_options,\n\t\t\t\t};\n\n\t\t\t\tif (!tasks.length) {\n\t\t\t\t\temptyState.removeClass(\"d-none\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tfrm.__project_tasks_data = tasks;\n\t\t\t\tfrm.events.render_task_hierarchy(frm, tasks, tableBody);\n\t\t\t},\n\t\t\terror: (err) => {\n\t\t\t\tconsole.error(\"Project Task Tab: API Error:\", err);\n\t\t\t\tloadingState.addClass(\"d-none\");\n\t\t\t\temptyState\n\t\t\t\t\t.removeClass(\"d-none\")\n\t\t\t\t\t.text(__(\"Unable to load tasks. Check console for errors.\"));\n\t\t\t\tfrappe.msgprint({\n\t\t\t\t\ttitle: __(\"Error Loading Tasks\"),\n\t\t\t\t\tmessage: __(\"Unable to load tasks. Please check browser console for details.\"),\n\t\t\t\t\tindicator: \"red\"\n\t\t\t\t});\n\t\t\t},\n\t\t});\n\t},\n\n\trender_task_hierarchy(frm, tasks, tableBody) {\n\t\t// Build parent-child map\n\t\tconst taskMap = {};\n\t\tconst rootTasks = [];\n\t\t\n\t\ttasks.forEach(t => {\n\t\t\ttaskMap[t.name] = { ...t, children: [], expanded: true };\n\t\t});\n\t\t\n\t\ttasks.forEach(t => {\n\t\t\tif (t.parent_task && taskMap[t.parent_task]) {\n\t\t\t\ttaskMap[t.parent_task].children.push(taskMap[t.name]);\n\t\t\t} else {\n\t\t\t\trootTasks.push(taskMap[t.name]);\n\t\t\t}\n\t\t});\n\t\t\n\t\t// Store task map in form for collapse/expand\n\t\tfrm.__task_hierarchy = taskMap;\n\t\t\n\t\t// Render recursively\n\t\tfunction renderTask(task, level = 0, parentExpanded = true) {\n\t\t\tconst row = frm.events.render_project_task_row(frm, task, level);\n\t\t\ttableBody.append(row);\n\t\t\t\n\t\t\t// Only show if parent is expanded\n\t\t\tif (!parentExpanded) {\n\t\t\t\trow.hide();\n\t\t\t}\n\t\t\t\n\t\t\t// Render children\n\t\t\tif (task.children && task.children.length > 0) {\n\t\t\t\ttask.children.forEach(child => {\n\t\t\t\t\trenderTask(child, level + 1, parentExpanded && task.expanded);\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\t\n\t\trootTasks.forEach(task => renderTask(task, 0, true));\n\t},\n\n\trender_project_task_row(frm, task, level = 0) {\n\t\tconst currency = frm.__project_task_meta?.currency;\n\t\tconst meta = frm.__project_task_meta || {};\n\t\tconst hasChildren = task.children && task.children.length > 0;\n\t\tconst indent = level * 20;\n\n\t\tconst toUserDate = (value) => (value ? frappe.datetime.str_to_user(value) : \"-\");\n\t\tconst toDays = (value) => (isNaN(value) || value === null ? \"-\" : `${value} ${__(\"days\")}`);\n\t\tconst toHours = (value) =>\n\t\t\tvalue === null || value === undefined ? \"-\" : frappe.format(value, { fieldtype: \"Float\", precision: 2 });\n\t\tconst toCurrency = (value) =>\n\t\t\tvalue === null || value === undefined\n\t\t\t\t? \"-\"\n\t\t\t\t: frappe.format(value, { fieldtype: \"Currency\", options: currency });\n\n\t\tconst row = $(`\n\t\t\t<tr data-task=\"${frappe.utils.escape_html(task.name)}\" \n\t\t\t    data-parent=\"${frappe.utils.escape_html(task.parent_task || '')}\"\n\t\t\t    data-level=\"${level}\"\n\t\t\t    class=\"${hasChildren ? 'table-primary parent-task' : 'child-task'}\">\n\t\t\t\t<td class=\"task-subject\" style=\"padding-left: ${indent + 10}px;\"></td>\n\t\t\t\t<td>${frappe.utils.escape_html(task.wbs || \"\")}</td>\n\t\t\t\t<td class=\"editable-cell\" data-field=\"status\">${frappe.utils.escape_html(task.status || \"\")}</td>\n\t\t\t\t<td class=\"editable-cell\" data-field=\"priority\">${frappe.utils.escape_html(task.priority || \"\")}</td>\n\t\t\t\t<td class=\"editable-cell\" data-field=\"exp_start_date\">${toUserDate(task.exp_start_date)}</td>\n\t\t\t\t<td class=\"editable-cell\" data-field=\"exp_end_date\">${toUserDate(task.exp_end_date)}</td>\n\t\t\t\t<td>${toDays(task.duration_days)}</td>\n\t\t\t\t<td class=\"editable-cell\" data-field=\"planned_hours\">${toHours(task.planned_hours)}</td>\n\t\t\t\t<td class=\"editable-cell\" data-field=\"custom_actual_start_date\" style=\"background-color: #f0f9ff;\">${toUserDate(task.custom_actual_start_date)}</td>\n\t\t\t\t<td class=\"editable-cell\" data-field=\"custom_actual_end_date\" style=\"background-color: #f0f9ff;\">${toUserDate(task.custom_actual_end_date)}</td>\n\t\t\t\t<td>${toDays(task.actual_duration_days)}</td>\n\t\t\t\t<td>${toHours(task.actual_hours)}</td>\n\t\t\t\t<td>${toCurrency(task.total_costing_amount)}</td>\n\t\t\t\t<td class=\"text-center\">\n\t\t\t\t\t<button class=\"btn btn-link btn-sm p-0 me-1\" data-role=\"add-child\" title=\"${__(\"Add Child Task\")}\">\n\t\t\t\t\t\t<svg class=\"icon icon-sm\"><use href=\"#icon-add\"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class=\"btn btn-link btn-sm p-0\" data-role=\"edit-task\" title=\"${__(\"Edit\")}\">\n\t\t\t\t\t\t<svg class=\"icon icon-sm\"><use href=\"#icon-edit\"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t`);\n\n\t\t// Subject cell with link and hierarchy indicator\n\t\tconst subjectCell = row.find(\".task-subject\");\n\t\t\n\t\tif (hasChildren) {\n\t\t\t// Collapsible triangle for parent tasks\n\t\t\tconst triangle = $(`\n\t\t\t\t<span class=\"collapse-triangle me-2\" style=\"cursor: pointer; user-select: none; font-size: 14px; display: inline-block; transition: transform 0.2s;\">\n\t\t\t\t\t‚ñº\n\t\t\t\t</span>\n\t\t\t`);\n\t\t\t\n\t\t\ttriangle.on(\"click\", (e) => {\n\t\t\t\te.stopPropagation();\n\t\t\t\tfrm.events.toggle_task_children(frm, task.name);\n\t\t\t});\n\t\t\t\n\t\t\tsubjectCell.append(triangle);\n\t\t} else {\n\t\t\t// Add spacing for alignment\n\t\t\tsubjectCell.append($('<span class=\"me-2\" style=\"width: 14px; display: inline-block;\"></span>'));\n\t\t}\n\t\t\n\t\tconst link = $(`<a class='${hasChildren ? \"fw-bold\" : \"\"}'>`)\n\t\t\t.text(task.subject || task.name)\n\t\t\t.on(\"click\", () => frappe.set_route(\"Form\", \"Task\", task.name));\n\t\tsubjectCell.append(link);\n\n\t\t// Make cells editable on click\n\t\trow.find(\".editable-cell\").on(\"click\", function() {\n\t\t\tfrm.events.make_cell_editable(frm, $(this), task, meta);\n\t\t});\n\n\t\t// Add child task button\n\t\trow.find(\"[data-role='add-child']\").on(\"click\", () => {\n\t\t\tfrm.events.open_project_task_dialog(frm, null, task.name);\n\t\t});\n\n\t\t// Edit task button\n\t\trow.find(\"[data-role='edit-task']\").on(\"click\", () => {\n\t\t\tfrm.events.open_project_task_dialog(frm, task);\n\t\t});\n\n\t\treturn row;\n\t},\n\n\ttoggle_task_children(frm, taskName) {\n\t\tconst taskMap = frm.__task_hierarchy || {};\n\t\tconst task = taskMap[taskName];\n\t\t\n\t\tif (!task || !task.children || task.children.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\t\n\t\t// Toggle expanded state\n\t\ttask.expanded = !task.expanded;\n\t\t\n\t\t// Find the row and triangle\n\t\tconst row = $(`tr[data-task=\"${taskName}\"]`);\n\t\tconst triangle = row.find(\".collapse-triangle\");\n\t\t\n\t\t// Toggle triangle class and rotation\n\t\tif (task.expanded) {\n\t\t\ttriangle.removeClass(\"collapsed\");\n\t\t\trow.removeClass(\"collapsed\");\n\t\t} else {\n\t\t\ttriangle.addClass(\"collapsed\");\n\t\t\trow.addClass(\"collapsed\");\n\t\t}\n\t\t\n\t\t// Toggle all descendant rows with animation\n\t\tfunction toggleDescendants(parentTask, show) {\n\t\t\tparentTask.children.forEach(child => {\n\t\t\t\tconst childRow = $(`tr[data-task=\"${child.name}\"]`);\n\t\t\t\t\n\t\t\t\tif (show && task.expanded) {\n\t\t\t\t\tchildRow.removeClass(\"hidden-by-collapse\").fadeIn(200);\n\t\t\t\t\t// If this child is also expanded and has children, show them too\n\t\t\t\t\tif (child.expanded && child.children && child.children.length > 0) {\n\t\t\t\t\t\ttoggleDescendants(child, true);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tchildRow.addClass(\"hidden-by-collapse\").fadeOut(200);\n\t\t\t\t\t// Hide all descendants regardless\n\t\t\t\t\tif (child.children && child.children.length > 0) {\n\t\t\t\t\t\ttoggleDescendants(child, false);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\t\n\t\ttoggleDescendants(task, task.expanded);\n\t\t\n\t\t// Show feedback\n\t\tconst childCount = task.children.length;\n\t\tconst action = task.expanded ? \"expanded\" : \"collapsed\";\n\t\tfrappe.show_alert({\n\t\t\tmessage: `${action === \"expanded\" ? \"‚ñº\" : \"‚ñ∂\"} ${childCount} child task${childCount > 1 ? \"s\" : \"\"} ${action}`,\n\t\t\tindicator: \"blue\"\n\t\t}, 2);\n\t},\n\n\tmake_cell_editable(frm, cell, task, meta) {\n\t\t// Prevent multiple edit sessions\n\t\tif (cell.data(\"editing\")) return;\n\t\tcell.data(\"editing\", true);\n\t\t\n\t\tconst field = cell.data(\"field\");\n\t\tconst currentValue = task[field];\n\t\tconst originalHtml = cell.html();\n\t\t\n\t\tcell.empty().css(\"padding\", \"2px\");\n\t\t\n\t\tlet input;\n\t\tif (field === \"status\") {\n\t\t\tinput = $(`<select class=\"form-control form-control-sm\" style=\"width: 100%;\"></select>`);\n\t\t\t(meta.status_options || []).forEach(opt => {\n\t\t\t\tinput.append($(\"<option>\").val(opt).text(opt).prop(\"selected\", opt === currentValue));\n\t\t\t});\n\t\t} else if (field === \"priority\") {\n\t\t\tinput = $(`<select class=\"form-control form-control-sm\" style=\"width: 100%;\"></select>`);\n\t\t\t(meta.priority_options || []).forEach(opt => {\n\t\t\t\tinput.append($(\"<option>\").val(opt).text(opt).prop(\"selected\", opt === currentValue));\n\t\t\t});\n\t\t} else if (field === \"exp_start_date\" || field === \"exp_end_date\" || field === \"custom_actual_start_date\" || field === \"custom_actual_end_date\") {\n\t\t\tinput = $(`<input type=\"date\" class=\"form-control form-control-sm\" style=\"width: 100%;\">`);\n\t\t\tif (currentValue) {\n\t\t\t\tinput.val(frappe.datetime.str_to_user(currentValue, \"yyyy-mm-dd\"));\n\t\t\t}\n\t\t} else if (field === \"planned_hours\") {\n\t\t\tinput = $(`<input type=\"number\" step=\"0.5\" class=\"form-control form-control-sm\" style=\"width: 100%;\">`);\n\t\t\tinput.val(currentValue || \"\");\n\t\t}\n\t\t\n\t\tcell.append(input);\n\t\t\n\t\t// Focus after a brief delay to ensure rendering\n\t\tsetTimeout(() => {\n\t\t\tinput.focus();\n\t\t\tif (input.is(\"select\")) {\n\t\t\t\tinput.click(); // Open dropdown\n\t\t\t}\n\t\t}, 50);\n\t\t\n\t\tlet saved = false;\n\t\t\n\t\tconst saveValue = () => {\n\t\t\tif (saved) return;\n\t\t\tsaved = true;\n\t\t\t\n\t\t\tconst newValue = input.val();\n\t\t\t\n\t\t\t// Restore cell appearance\n\t\t\tcell.data(\"editing\", false);\n\t\t\tcell.css(\"padding\", \"\");\n\t\t\t\n\t\t\tif (newValue && newValue !== currentValue) {\n\t\t\t\tconst updates = {};\n\t\t\t\tupdates[field] = newValue;\n\t\t\t\tcell.html(`<span class=\"text-muted\"><i>Saving...</i></span>`);\n\t\t\t\tfrm.events.quick_update_task(frm, task.name, updates);\n\t\t\t} else {\n\t\t\t\t// Just restore original\n\t\t\t\tcell.html(originalHtml);\n\t\t\t}\n\t\t};\n\t\t\n\t\tconst cancelEdit = () => {\n\t\t\tif (saved) return;\n\t\t\tsaved = true;\n\t\t\tcell.data(\"editing\", false);\n\t\t\tcell.css(\"padding\", \"\");\n\t\t\tcell.html(originalHtml);\n\t\t};\n\t\t\n\t\t// For select, save on change\n\t\tif (input.is(\"select\")) {\n\t\t\tinput.on(\"change\", () => {\n\t\t\t\tsaveValue();\n\t\t\t});\n\t\t\tinput.on(\"blur\", () => {\n\t\t\t\tsetTimeout(cancelEdit, 100);\n\t\t\t});\n\t\t} else {\n\t\t\t// For inputs, save on blur or enter\n\t\t\tinput.on(\"blur\", () => {\n\t\t\t\tsetTimeout(saveValue, 100);\n\t\t\t});\n\t\t\tinput.on(\"keydown\", (e) => {\n\t\t\t\tif (e.which === 13) { // Enter\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tsaveValue();\n\t\t\t\t} else if (e.which === 27) { // Escape\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tcancelEdit();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\t\n\t\t// Prevent click from bubbling\n\t\tinput.on(\"click\", (e) => {\n\t\t\te.stopPropagation();\n\t\t});\n\t},\n\n\tquick_update_task(frm, taskName, updates) {\n\t\tfrappe.call({\n\t\t\tmethod: \"milestoneksa.api.project_tasks.update_project_task\",\n\t\t\targs: {\n\t\t\t\ttask_name: taskName,\n\t\t\t\tupdates: updates,\n\t\t\t},\n\t\t\tfreeze: false,\n\t\t\tcallback: () => {\n\t\t\t\tfrappe.show_alert({ message: __(\"Task updated\"), indicator: \"green\" });\n\t\t\t\tfrm.events.load_project_tasks(frm);\n\t\t\t},\n\t\t});\n\t},\n\n\topen_project_task_dialog(frm, task = null, parentTask = null) {\n\t\tconst isEdit = Boolean(task);\n\t\tconst meta = frm.__project_task_meta || {};\n\t\tconst statusOptions = meta.status_options || [\"Open\", \"Working\", \"Pending Review\", \"Overdue\", \"Completed\", \"Cancelled\"];\n\t\tconst priorityOptions = meta.priority_options || [\"Low\", \"Medium\", \"High\", \"Urgent\"];\n\n\t\tconst dialog = new frappe.ui.Dialog({\n\t\t\ttitle: isEdit ? __(\"Update Task\") : (parentTask ? __(\"Add Child Task\") : __(\"Add Task\")),\n\t\t\tfields: [\n\t\t\t\t{ fieldname: \"subject\", label: __(\"Subject\"), fieldtype: \"Data\", reqd: 1 },\n\t\t\t\t{ \n\t\t\t\t\tfieldname: \"is_group\", \n\t\t\t\t\tlabel: __(\"Is Group (Parent Task)\"), \n\t\t\t\t\tfieldtype: \"Check\",\n\t\t\t\t\tdefault: 0,\n\t\t\t\t\tdescription: __(\"Check this if this task will have child tasks\")\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tfieldname: \"status\",\n\t\t\t\t\tlabel: __(\"Status\"),\n\t\t\t\t\tfieldtype: \"Select\",\n\t\t\t\t\toptions: statusOptions.join(\"\\n\"),\n\t\t\t\t\tdefault: \"Open\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tfieldname: \"priority\",\n\t\t\t\t\tlabel: __(\"Priority\"),\n\t\t\t\t\tfieldtype: \"Select\",\n\t\t\t\t\toptions: priorityOptions.join(\"\\n\"),\n\t\t\t\t\tdefault: \"Medium\",\n\t\t\t\t},\n\t\t\t\t{ fieldname: \"col_break_1\", fieldtype: \"Column Break\" },\n\t\t\t\t{ fieldname: \"exp_start_date\", label: __(\"Planned Start\"), fieldtype: \"Date\" },\n\t\t\t\t{ fieldname: \"exp_end_date\", label: __(\"Planned Finish\"), fieldtype: \"Date\" },\n\t\t\t\t{ fieldname: \"planned_hours\", label: __(\"Planned Hours\"), fieldtype: \"Float\" },\n\t\t\t\t{ fieldname: \"section_actual\", label: __(\"Actual Dates\"), fieldtype: \"Section Break\" },\n\t\t\t\t{ fieldname: \"custom_actual_start_date\", label: __(\"Actual Start Date\"), fieldtype: \"Date\" },\n\t\t\t\t{ fieldname: \"col_break_2\", fieldtype: \"Column Break\" },\n\t\t\t\t{ fieldname: \"custom_actual_end_date\", label: __(\"Actual End Date\"), fieldtype: \"Date\" },\n\t\t\t\t{ fieldname: \"section_more\", label: __(\"More Details\"), fieldtype: \"Section Break\", collapsible: 1 },\n\t\t\t\t{\n\t\t\t\t\tfieldname: \"parent_task\",\n\t\t\t\t\tlabel: __(\"Parent Task\"),\n\t\t\t\t\tfieldtype: \"Link\",\n\t\t\t\t\toptions: \"Task\",\n\t\t\t\t\tdescription: __(\"Optional: link this task beneath another task.\"),\n\t\t\t\t\tdefault: parentTask || \"\",\n\t\t\t\t\tread_only: parentTask ? 1 : 0,\n\t\t\t\t\tdepends_on: \"eval:!doc.is_group\",\n\t\t\t\t},\n\t\t\t\t{ fieldname: \"description\", label: __(\"Description\"), fieldtype: \"Small Text\" },\n\t\t\t],\n\t\t\tprimary_action_label: isEdit ? __(\"Update\") : __(\"Create\"),\n\t\t\tprimary_action(values) {\n\t\t\t\tif (!values.subject) {\n\t\t\t\t\tfrappe.msgprint(__(\"Subject is required.\"));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (isEdit) {\n\t\t\t\t\tfrm.events.submit_task_update(frm, task.name, values, dialog);\n\t\t\t\t} else {\n\t\t\t\t\tfrm.events.submit_task_create(frm, values, dialog);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\n\t\tif (isEdit) {\n\t\t\tdialog.set_values({\n\t\t\t\tsubject: task.subject,\n\t\t\t\tis_group: task.is_group || 0,\n\t\t\t\tstatus: task.status,\n\t\t\t\tpriority: task.priority,\n\t\t\t\texp_start_date: task.exp_start_date,\n\t\t\t\texp_end_date: task.exp_end_date,\n\t\t\t\tplanned_hours: task.planned_hours,\n\t\t\t\tcustom_actual_start_date: task.custom_actual_start_date,\n\t\t\t\tcustom_actual_end_date: task.custom_actual_end_date,\n\t\t\t\tparent_task: task.parent_task,\n\t\t\t\tdescription: task.description,\n\t\t\t});\n\t\t}\n\n\t\tdialog.show();\n\t},\n\n\tsubmit_task_create(frm, values, dialog) {\n\t\tfrappe.call({\n\t\t\tmethod: \"milestoneksa.api.project_tasks.create_project_task\",\n\t\t\targs: {\n\t\t\t\tproject: frm.doc.name,\n\t\t\t\ttask: values,\n\t\t\t},\n\t\t\tfreeze: true,\n\t\t\tfreeze_message: __(\"Creating task...\"),\n\t\t\tcallback: () => {\n\t\t\t\tdialog.hide();\n\t\t\t\tfrappe.show_alert({ message: __(\"Task created\"), indicator: \"green\" });\n\t\t\t\tfrm.events.load_project_tasks(frm);\n\t\t\t},\n\t\t});\n\t},\n\n\tsubmit_task_update(frm, taskName, values, dialog) {\n\t\tfrappe.call({\n\t\t\tmethod: \"milestoneksa.api.project_tasks.update_project_task\",\n\t\t\targs: {\n\t\t\t\ttask_name: taskName,\n\t\t\t\tupdates: values,\n\t\t\t},\n\t\t\tfreeze: true,\n\t\t\tfreeze_message: __(\"Updating task...\"),\n\t\t\tcallback: () => {\n\t\t\t\tdialog.hide();\n\t\t\t\tfrappe.show_alert({ message: __(\"Task updated\"), indicator: \"green\" });\n\t\t\t\tfrm.events.load_project_tasks(frm);\n\t\t\t},\n\t\t});\n\t},\n});\n\n\n\n// === ENHANCED DASHBOARD v2 ===\n\nfrappe.ui.form.on(\"Project\", {\n\trefresh(frm) {\n\t\tfrm.events.render_project_dashboard(frm);\n\t},\n\n\tafter_save(frm) {\n\t\tfrm.events.render_project_dashboard(frm);\n\t},\n\n\trender_project_dashboard(frm) {\n\t\tconsole.log(\"üîç Dashboard: render_project_dashboard called\");\n\t\t\n\t\tconst field = frm.fields_dict.custom_dashboard_html;\n\t\tif (!field) {\n\t\t\tconsole.warn(\"‚ùå Dashboard: custom_dashboard_html field not found\");\n\t\t\treturn;\n\t\t}\n\n\t\tconst wrapper = field.$wrapper;\n\t\twrapper.empty().addClass(\"project-dashboard-wrapper\").css({\n\t\t\t\"padding\": \"20px\",\n\t\t\t\"background\": \"#f8f9fa\",\n\t\t\t\"min-height\": \"600px\"\n\t\t});\n\n\t\tif (frm.is_new()) {\n\t\t\twrapper.append(\n\t\t\t\t$(\"<div class='alert alert-info'>\").text(__(\"Save the project to view the dashboard.\"))\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\t// Load Chart.js if not already loaded\n\t\tif (typeof Chart === 'undefined') {\n\t\t\tconsole.log(\"üìä Dashboard: Loading Chart.js...\");\n\t\t\tfrappe.require('https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js', () => {\n\t\t\t\tconsole.log(\"‚úÖ Dashboard: Chart.js loaded\");\n\t\t\t\tfrm.events.init_dashboard_content(frm, wrapper);\n\t\t\t});\n\t\t} else {\n\t\t\tconsole.log(\"‚úÖ Dashboard: Chart.js already loaded\");\n\t\t\tfrm.events.init_dashboard_content(frm, wrapper);\n\t\t}\n\t},\n\t\n\tinit_dashboard_content(frm, wrapper) {\n\t\t// Add CSS styles\n\t\twrapper.append(frm.events.get_dashboard_styles());\n\t\t\n\t\t// Date filter section\n\t\tconst filterSection = frm.events.create_date_filter(frm);\n\t\twrapper.append(filterSection);\n\t\t\n\t\t// Loading state\n\t\tconst loadingDiv = $(`\n\t\t\t<div class=\"text-center mt-5\" data-role=\"dashboard-loading\">\n\t\t\t\t<div class=\"spinner-border text-primary\" style=\"width: 3rem; height: 3rem;\"></div>\n\t\t\t\t<div class=\"mt-3\">${__(\"Loading dashboard...\")}</div>\n\t\t\t</div>\n\t\t`);\n\t\twrapper.append(loadingDiv);\n\t\t\n\t\t// Load dashboard data\n\t\tfrm.events.load_dashboard_data(frm);\n\t},\n\n\tget_dashboard_styles() {\n\t\treturn $(`\n\t\t\t<style>\n\t\t\t\t/* Dashboard Container */\n\t\t\t\t.project-dashboard-wrapper {\n\t\t\t\t\tfont-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* KPI Cards */\n\t\t\t\t.dashboard-kpi-grid {\n\t\t\t\t\tdisplay: grid;\n\t\t\t\t\tgrid-template-columns: repeat(auto-fit, minmax(220px, 1fr));\n\t\t\t\t\tgap: 16px;\n\t\t\t\t\tmargin-bottom: 30px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.kpi-card {\n\t\t\t\t\tbackground: white;\n\t\t\t\t\tborder-radius: 12px;\n\t\t\t\t\tpadding: 24px;\n\t\t\t\t\tbox-shadow: 0 2px 8px rgba(0,0,0,0.08);\n\t\t\t\t\ttransition: all 0.3s ease;\n\t\t\t\t\tborder-left: 4px solid #6c757d;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.kpi-card:hover {\n\t\t\t\t\ttransform: translateY(-4px);\n\t\t\t\t\tbox-shadow: 0 4px 16px rgba(0,0,0,0.12);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.kpi-card.good { border-left-color: #28a745; }\n\t\t\t\t.kpi-card.warning { border-left-color: #ffc107; }\n\t\t\t\t.kpi-card.danger { border-left-color: #dc3545; }\n\t\t\t\t.kpi-card.info { border-left-color: #17a2b8; }\n\t\t\t\t\n\t\t\t\t.kpi-card-title {\n\t\t\t\t\tfont-size: 12px;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t\ttext-transform: uppercase;\n\t\t\t\t\tletter-spacing: 0.5px;\n\t\t\t\t\tcolor: #6c757d;\n\t\t\t\t\tmargin-bottom: 12px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.kpi-card-value {\n\t\t\t\t\tfont-size: 32px;\n\t\t\t\t\tfont-weight: 700;\n\t\t\t\t\tcolor: #212529;\n\t\t\t\t\tmargin-bottom: 8px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.kpi-card-subtitle {\n\t\t\t\t\tfont-size: 13px;\n\t\t\t\t\tcolor: #6c757d;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.kpi-card-change {\n\t\t\t\t\tdisplay: inline-block;\n\t\t\t\t\tpadding: 4px 8px;\n\t\t\t\t\tborder-radius: 4px;\n\t\t\t\t\tfont-size: 11px;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t\tmargin-top: 8px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.kpi-card-change.positive {\n\t\t\t\t\tbackground: #d4edda;\n\t\t\t\t\tcolor: #155724;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.kpi-card-change.negative {\n\t\t\t\t\tbackground: #f8d7da;\n\t\t\t\t\tcolor: #721c24;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Charts Section */\n\t\t\t\t.dashboard-charts-grid {\n\t\t\t\t\tdisplay: grid;\n\t\t\t\t\tgrid-template-columns: repeat(auto-fit, minmax(400px, 1fr));\n\t\t\t\t\tgap: 20px;\n\t\t\t\t\tmargin-bottom: 30px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.chart-card {\n\t\t\t\t\tbackground: white;\n\t\t\t\t\tborder-radius: 12px;\n\t\t\t\t\tpadding: 24px;\n\t\t\t\t\tbox-shadow: 0 2px 8px rgba(0,0,0,0.08);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.chart-card-title {\n\t\t\t\t\tfont-size: 16px;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t\tcolor: #212529;\n\t\t\t\t\tmargin-bottom: 20px;\n\t\t\t\t\tpadding-bottom: 12px;\n\t\t\t\t\tborder-bottom: 2px solid #e9ecef;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Date Filter */\n\t\t\t\t.dashboard-date-filter {\n\t\t\t\t\tbackground: white;\n\t\t\t\t\tpadding: 16px 20px;\n\t\t\t\t\tborder-radius: 8px;\n\t\t\t\t\tmargin-bottom: 24px;\n\t\t\t\t\tbox-shadow: 0 1px 4px rgba(0,0,0,0.06);\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\tgap: 12px;\n\t\t\t\t\talign-items: center;\n\t\t\t\t\tflex-wrap: wrap;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.dashboard-date-filter .btn-group {\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\tgap: 4px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.dashboard-date-filter .btn {\n\t\t\t\t\tpadding: 6px 16px;\n\t\t\t\t\tfont-size: 13px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Table Styling */\n\t\t\t\t.dashboard-table {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\tfont-size: 13px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.dashboard-table th {\n\t\t\t\t\tbackground: #f8f9fa;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t\tpadding: 12px;\n\t\t\t\t\tborder-bottom: 2px solid #dee2e6;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.dashboard-table td {\n\t\t\t\t\tpadding: 10px 12px;\n\t\t\t\t\tborder-bottom: 1px solid #e9ecef;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Progress Bars */\n\t\t\t\t.mini-progress {\n\t\t\t\t\theight: 8px;\n\t\t\t\t\tborder-radius: 4px;\n\t\t\t\t\tbackground: #e9ecef;\n\t\t\t\t\toverflow: hidden;\n\t\t\t\t\tmargin-top: 8px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.mini-progress-bar {\n\t\t\t\t\theight: 100%;\n\t\t\t\t\tbackground: linear-gradient(90deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\ttransition: width 0.6s ease;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Responsive */\n\t\t\t\t@media (max-width: 768px) {\n\t\t\t\t\t.dashboard-kpi-grid {\n\t\t\t\t\t\tgrid-template-columns: 1fr;\n\t\t\t\t\t}\n\t\t\t\t\t.dashboard-charts-grid {\n\t\t\t\t\t\tgrid-template-columns: 1fr;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t</style>\n\t\t`);\n\t},\n\n\tcreate_date_filter(frm) {\n\t\tconst filterDiv = $(`\n\t\t\t<div class=\"dashboard-date-filter\">\n\t\t\t\t<strong class=\"me-2\">${__(\"Period\")}:</strong>\n\t\t\t\t<div class=\"btn-group\" role=\"group\">\n\t\t\t\t\t<button type=\"button\" class=\"btn btn-sm btn-outline-primary\" data-period=\"week\">${__(\"This Week\")}</button>\n\t\t\t\t\t<button type=\"button\" class=\"btn btn-sm btn-outline-primary\" data-period=\"month\">${__(\"This Month\")}</button>\n\t\t\t\t\t<button type=\"button\" class=\"btn btn-sm btn-outline-primary\" data-period=\"quarter\">${__(\"This Quarter\")}</button>\n\t\t\t\t\t<button type=\"button\" class=\"btn btn-sm btn-outline-primary active\" data-period=\"all\">${__(\"All Time\")}</button>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"ms-auto d-flex gap-2 align-items-center\">\n\t\t\t\t\t<input type=\"date\" class=\"form-control form-control-sm\" data-field=\"from_date\" placeholder=\"${__(\"From Date\")}\" style=\"width: 140px;\">\n\t\t\t\t\t<span>-</span>\n\t\t\t\t\t<input type=\"date\" class=\"form-control form-control-sm\" data-field=\"to_date\" placeholder=\"${__(\"To Date\")}\" style=\"width: 140px;\">\n\t\t\t\t\t<button class=\"btn btn-sm btn-primary\" data-action=\"apply-filter\">${__(\"Apply\")}</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`);\n\t\t\n\t\t// Quick period buttons\n\t\tfilterDiv.find(\"[data-period]\").on(\"click\", function() {\n\t\t\tfilterDiv.find(\"[data-period]\").removeClass(\"active\");\n\t\t\t$(this).addClass(\"active\");\n\t\t\t\n\t\t\tconst period = $(this).data(\"period\");\n\t\t\tlet from_date = null;\n\t\t\tlet to_date = null;\n\t\t\t\n\t\t\tconst today = frappe.datetime.get_today();\n\t\t\t\n\t\t\tif (period === \"week\") {\n\t\t\t\tfrom_date = frappe.datetime.week_start();\n\t\t\t\tto_date = frappe.datetime.week_end();\n\t\t\t} else if (period === \"month\") {\n\t\t\t\tfrom_date = frappe.datetime.month_start();\n\t\t\t\tto_date = frappe.datetime.month_end();\n\t\t\t} else if (period === \"quarter\") {\n\t\t\t\tconst quarter_start = frappe.datetime.get_first_day_of_the_week(today);\n\t\t\t\tfrom_date = frappe.datetime.add_days(quarter_start, -90);\n\t\t\t\tto_date = today;\n\t\t\t}\n\t\t\t\n\t\t\tfrm.__dashboard_from_date = from_date;\n\t\t\tfrm.__dashboard_to_date = to_date;\n\t\t\t\n\t\t\tif (from_date) {\n\t\t\t\tfilterDiv.find(\"[data-field='from_date']\").val(from_date);\n\t\t\t}\n\t\t\tif (to_date) {\n\t\t\t\tfilterDiv.find(\"[data-field='to_date']\").val(to_date);\n\t\t\t}\n\t\t\t\n\t\t\tif (period !== \"all\") {\n\t\t\t\tfrm.events.load_dashboard_data(frm, from_date, to_date);\n\t\t\t} else {\n\t\t\t\tfrm.events.load_dashboard_data(frm);\n\t\t\t}\n\t\t});\n\t\t\n\t\t// Custom date apply button\n\t\tfilterDiv.find(\"[data-action='apply-filter']\").on(\"click\", () => {\n\t\t\tconst from_date = filterDiv.find(\"[data-field='from_date']\").val();\n\t\t\tconst to_date = filterDiv.find(\"[data-field='to_date']\").val();\n\t\t\t\n\t\t\tfrm.__dashboard_from_date = from_date;\n\t\t\tfrm.__dashboard_to_date = to_date;\n\t\t\t\n\t\t\tfrm.events.load_dashboard_data(frm, from_date, to_date);\n\t\t});\n\t\t\n\t\treturn filterDiv;\n\t},\n\n\tload_dashboard_data(frm, from_date = null, to_date = null) {\n\t\tconsole.log(\"üîç Dashboard: Loading data...\", {project: frm.doc.name, from_date, to_date});\n\t\t\n\t\tconst wrapper = frm.fields_dict.custom_dashboard_html.$wrapper;\n\t\tconst loading = wrapper.find(\"[data-role='dashboard-loading']\");\n\t\tconst content = wrapper.find(\"[data-role='dashboard-content']\");\n\t\t\n\t\tloading.show();\n\t\tcontent.remove();\n\t\t\n\t\tfrappe.call({\n\t\t\tmethod: \"milestoneksa.api.project_dashboard.get_dashboard_data\",\n\t\t\targs: {\n\t\t\t\tproject: frm.doc.name,\n\t\t\t\tfrom_date: from_date,\n\t\t\t\tto_date: to_date\n\t\t\t},\n\t\t\tcallback: (r) => {\n\t\t\t\tconsole.log(\"üîç Dashboard: API Response received\", r);\n\t\t\t\tloading.hide();\n\t\t\t\t\n\t\t\t\tif (!r || !r.message) {\n\t\t\t\t\tconsole.error(\"‚ùå Dashboard: No data in response\");\n\t\t\t\t\twrapper.append(`<div class=\"alert alert-danger\">${__(\"Failed to load dashboard data\")}</div>`);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tconst data = r.message;\n\t\t\t\tconsole.log(\"‚úÖ Dashboard: Data structure:\", {\n\t\t\t\t\tfinancial: data.financial,\n\t\t\t\t\ttimeline: data.timeline,\n\t\t\t\t\ttasks: data.tasks,\n\t\t\t\t\tteam: data.team,\n\t\t\t\t\ttrends: data.trends\n\t\t\t\t});\n\t\t\t\tfrm.__dashboard_data = data;\n\t\t\t\t\n\t\t\t\tconst contentDiv = $(\"<div data-role='dashboard-content'></div>\");\n\t\t\t\t\n\t\t\t\t// KPI Cards\n\t\t\t\tcontentDiv.append(frm.events.render_kpi_cards(frm, data));\n\t\t\t\t\n\t\t\t\t// Charts\n\t\t\t\tcontentDiv.append(frm.events.render_charts(frm, data));\n\t\t\t\t\n\t\t\t\t// Tables\n\t\t\t\tcontentDiv.append(frm.events.render_tables(frm, data));\n\t\t\t\t\n\t\t\t\twrapper.append(contentDiv);\n\t\t\t\t\n\t\t\t\t// Add export button to toolbar\n\t\t\t\tfrm.events.add_dashboard_toolbar(frm);\n\t\t\t},\n\t\t\terror: (err) => {\n\t\t\t\tconsole.error(\"‚ùå Dashboard: API Error\", err);\n\t\t\t\tloading.hide();\n\t\t\t\twrapper.append(`\n\t\t\t\t\t<div class=\"alert alert-danger\">\n\t\t\t\t\t\t<h5>${__(\"Error loading dashboard\")}</h5>\n\t\t\t\t\t\t<p>${__(\"Check browser console (F12) for details.\")}</p>\n\t\t\t\t\t\t<small>${err.message || err.exc || 'Unknown error'}</small>\n\t\t\t\t\t</div>\n\t\t\t\t`);\n\t\t\t}\n\t\t});\n\t},\n\n\trender_kpi_cards(frm, data) {\n\t\tconsole.log(\"üîç Dashboard: Rendering KPI cards with data\", data);\n\t\t\n\t\tconst kpiGrid = $(\"<div class='dashboard-kpi-grid'></div>\");\n\t\t\n\t\t// Project Health Score Card (NEW!)\n\t\tconst health = data.health || {};\n\t\tconst healthCard = frm.events.create_health_card(health);\n\t\tkpiGrid.append(healthCard);\n\t\t\n\t\t// Financial Card\n\t\tconst financial = data.financial || {};\n\t\tconst finCard = frm.events.create_kpi_card(\n\t\t\t\"üí∞ \" + __(\"Actual Cost\"),\n\t\t\tfrappe.format(financial.actual_cost, {fieldtype: \"Currency\"}),\n\t\t\tfinancial.estimated_budget > 0 ? `${__(\"of\")} ${frappe.format(financial.estimated_budget, {fieldtype: \"Currency\"})} ${__(\"budget\")}` : __(\"No budget set\"),\n\t\t\tfinancial.budget_health || \"info\",\n\t\t\tfinancial.budget_variance_pct ? `${financial.budget_variance_pct > 0 ? '+' : ''}${financial.budget_variance_pct.toFixed(1)}%` : null\n\t\t);\n\t\tkpiGrid.append(finCard);\n\t\t\n\t\t// Revenue Card (NEW!)\n\t\tconst revenueCard = frm.events.create_kpi_card(\n\t\t\t\"üíµ \" + __(\"Revenue\"),\n\t\t\tfrappe.format(financial.total_revenue, {fieldtype: \"Currency\"}),\n\t\t\t`${__(\"Billed\")}: ${frappe.format(financial.total_billed, {fieldtype: \"Currency\"})}`,\n\t\t\tfinancial.total_revenue > 0 ? \"good\" : \"info\",\n\t\t\tfinancial.revenue_realization_pct ? `${financial.revenue_realization_pct.toFixed(0)}% ${__(\"realized\")}` : null\n\t\t);\n\t\tkpiGrid.append(revenueCard);\n\t\t\n\t\t// Profitability Card (NEW!)\n\t\tconst profitCard = frm.events.create_kpi_card(\n\t\t\t\"üìä \" + __(\"Gross Profit\"),\n\t\t\tfrappe.format(financial.gross_profit, {fieldtype: \"Currency\"}),\n\t\t\t`${__(\"Margin\")}: ${financial.profit_margin_pct.toFixed(1)}%`,\n\t\t\tfinancial.gross_profit >= 0 ? \"good\" : \"danger\",\n\t\t\tfinancial.gross_profit >= 0 ? __(\"Profitable\") : __(\"Loss\")\n\t\t);\n\t\tkpiGrid.append(profitCard);\n\t\t\n\t\t// Timeline Card\n\t\tconst timeline = data.timeline || {};\n\t\tconst timeCard = frm.events.create_kpi_card(\n\t\t\t\"üìÖ \" + __(\"Timeline\"),\n\t\t\ttimeline.days_remaining >= 0 ? `${timeline.days_remaining} ${__(\"days left\")}` : __(\"Completed\"),\n\t\t\ttimeline.delay_days ? `${timeline.delay_days} ${__(\"days delay\")}` : __(\"On schedule\"),\n\t\t\ttimeline.status === \"delayed\" ? \"warning\" : \"good\",\n\t\t\t`${timeline.percent_complete || 0}% ${__(\"complete\")}`\n\t\t);\n\t\tkpiGrid.append(timeCard);\n\t\t\n\t\t// Tasks Card\n\t\tconst tasks = data.tasks || {};\n\t\tconst taskCard = frm.events.create_kpi_card(\n\t\t\t\"‚úÖ \" + __(\"Tasks\"),\n\t\t\t`${tasks.completed || 0}/${tasks.total || 0}`,\n\t\t\t__(\"completed\"),\n\t\t\ttasks.completion_pct >= 80 ? \"good\" : (tasks.completion_pct >= 50 ? \"warning\" : \"info\"),\n\t\t\ttasks.overdue ? `${tasks.overdue} ${__(\"overdue\")}` : __(\"None overdue\")\n\t\t);\n\t\tkpiGrid.append(taskCard);\n\t\t\n\t\t// Team Card\n\t\tconst team = data.team || {};\n\t\tconst teamCard = frm.events.create_kpi_card(\n\t\t\t\"üë• \" + __(\"Team\"),\n\t\t\t`${team.total_hours || 0} ${__(\"hrs\")}`,\n\t\t\t`${team.team_size || 0} ${__(\"members\")}`,\n\t\t\tteam.team_size > 0 ? \"good\" : \"warning\",\n\t\t\tteam.total_hours && team.team_size ? `${(team.total_hours / team.team_size).toFixed(1)} ${__(\"hrs/person\")}` : __(\"No team assigned\")\n\t\t);\n\t\tkpiGrid.append(teamCard);\n\t\t\n\t\treturn kpiGrid;\n\t},\n\t\n\tcreate_health_card(health) {\n\t\tconst score = health.score || 0;\n\t\tconst level = health.level || \"warning\";\n\t\tconst components = health.components || {};\n\t\t\n\t\tlet color, bgColor, label;\n\t\tif (level === \"excellent\") {\n\t\t\tcolor = \"#28a745\";\n\t\t\tbgColor = \"#d4edda\";\n\t\t\tlabel = \"Excellent\";\n\t\t} else if (level === \"good\") {\n\t\t\tcolor = \"#17a2b8\";\n\t\t\tbgColor = \"#d1ecf1\";\n\t\t\tlabel = \"Good\";\n\t\t} else if (level === \"warning\") {\n\t\t\tcolor = \"#ffc107\";\n\t\t\tbgColor = \"#fff3cd\";\n\t\t\tlabel = \"Needs Attention\";\n\t\t} else {\n\t\t\tcolor = \"#dc3545\";\n\t\t\tbgColor = \"#f8d7da\";\n\t\t\tlabel = \"At Risk\";\n\t\t}\n\t\t\n\t\tconst card = $(`\n\t\t\t<div class=\"kpi-card ${level}\" style=\"grid-column: span 1; border-left-color: ${color};\">\n\t\t\t\t<div class=\"kpi-card-title\">üèÜ ${__(\"Project Health\")}</div>\n\t\t\t\t<div class=\"kpi-card-value\" style=\"color: ${color};\">${score}/100</div>\n\t\t\t\t<div class=\"kpi-card-subtitle\">${__(label)}</div>\n\t\t\t\t<div class=\"health-breakdown mt-3\" style=\"font-size: 11px;\">\n\t\t\t\t\t<div class=\"d-flex justify-content-between mb-1\">\n\t\t\t\t\t\t<span>üí∞ Budget:</span>\n\t\t\t\t\t\t<span class=\"fw-bold\">${components.budget || 0}/30</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"d-flex justify-content-between mb-1\">\n\t\t\t\t\t\t<span>üìÖ Schedule:</span>\n\t\t\t\t\t\t<span class=\"fw-bold\">${components.schedule || 0}/30</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"d-flex justify-content-between mb-1\">\n\t\t\t\t\t\t<span>‚úÖ Tasks:</span>\n\t\t\t\t\t\t<span class=\"fw-bold\">${components.tasks || 0}/25</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"d-flex justify-content-between\">\n\t\t\t\t\t\t<span>üë• Team:</span>\n\t\t\t\t\t\t<span class=\"fw-bold\">${components.team || 0}/15</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`);\n\t\t\n\t\treturn card;\n\t},\n\n\tcreate_kpi_card(title, value, subtitle, status = \"info\", badge = null) {\n\t\tconst card = $(`\n\t\t\t<div class=\"kpi-card ${status}\">\n\t\t\t\t<div class=\"kpi-card-title\">${title}</div>\n\t\t\t\t<div class=\"kpi-card-value\">${value}</div>\n\t\t\t\t<div class=\"kpi-card-subtitle\">${subtitle}</div>\n\t\t\t\t${badge ? `<div class=\"kpi-card-change ${status === 'good' ? 'positive' : (status === 'danger' || status === 'warning' ? 'negative' : '')}\">${badge}</div>` : ''}\n\t\t\t</div>\n\t\t`);\n\t\treturn card;\n\t},\n\n\trender_charts(frm, data) {\n\t\tconst chartsGrid = $(\"<div class='dashboard-charts-grid'></div>\");\n\t\t\n\t\t// Profit vs Cost Chart (NEW!)\n\t\tconst profitChart = frm.events.create_profit_chart(data.financial);\n\t\tchartsGrid.append(profitChart);\n\t\t\n\t\t// Financial Breakdown Chart\n\t\tconst finChart = frm.events.create_financial_chart(data.financial);\n\t\tchartsGrid.append(finChart);\n\t\t\n\t\t// Task Status Chart\n\t\tconst taskChart = frm.events.create_task_status_chart(data.tasks);\n\t\tchartsGrid.append(taskChart);\n\t\t\n\t\t// Cost Trend Chart\n\t\tconst costTrendChart = frm.events.create_cost_trend_chart(data.trends);\n\t\tchartsGrid.append(costTrendChart);\n\t\t\n\t\t// Task Completion Trend\n\t\tconst completionChart = frm.events.create_completion_trend_chart(data.trends);\n\t\tchartsGrid.append(completionChart);\n\t\t\n\t\t// Task Priority Distribution (NEW!)\n\t\tconst priorityChart = frm.events.create_priority_chart(data.tasks);\n\t\tchartsGrid.append(priorityChart);\n\t\t\n\t\t// Team Breakdown Chart (NEW!)\n\t\tconst teamChart = frm.events.create_team_chart(data.team);\n\t\tchartsGrid.append(teamChart);\n\t\t\n\t\treturn chartsGrid;\n\t},\n\t\n\tcreate_team_chart(team) {\n\t\tconsole.log(\"üîç Dashboard: Creating team chart\", team);\n\t\t\n\t\tconst card = $(`\n\t\t\t<div class=\"chart-card\">\n\t\t\t\t<div class=\"chart-card-title\">üë• ${__(\"Team Hours Breakdown\")}</div>\n\t\t\t\t<div class=\"chart-container\" style=\"height: 250px;\"></div>\n\t\t\t</div>\n\t\t`);\n\t\t\n\t\tconst breakdown = team.user_breakdown || [];\n\t\t\n\t\tif (breakdown.length === 0) {\n\t\t\tcard.find(\".chart-container\").html(`\n\t\t\t\t<div class=\"text-center text-muted pt-5\">\n\t\t\t\t\t<p>${__(\"No timesheet data available\")}</p>\n\t\t\t\t\t<small>${__(\"Assign team members and log timesheets to see breakdown\")}</small>\n\t\t\t\t</div>\n\t\t\t`);\n\t\t\treturn card;\n\t\t}\n\t\t\n\t\tsetTimeout(() => {\n\t\t\tconst canvas = $(\"<canvas></canvas>\");\n\t\t\tcard.find(\".chart-container\").append(canvas);\n\t\t\t\n\t\t\t// Sort and take top 10\n\t\t\tconst topUsers = breakdown.slice(0, 10);\n\t\t\tconst labels = topUsers.map(u => u.user.split('@')[0]);  // Get username before @\n\t\t\tconst values = topUsers.map(u => u.hours);\n\t\t\t\n\t\t\ttry {\n\t\t\t\tnew Chart(canvas[0], {\n\t\t\t\t\ttype: 'horizontalBar',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tlabels: labels,\n\t\t\t\t\t\tdatasets: [{\n\t\t\t\t\t\t\tlabel: __('Hours'),\n\t\t\t\t\t\t\tdata: values,\n\t\t\t\t\t\t\tbackgroundColor: '#4e73df',\n\t\t\t\t\t\t\tborderWidth: 0\n\t\t\t\t\t\t}]\n\t\t\t\t\t},\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tresponsive: true,\n\t\t\t\t\t\tmaintainAspectRatio: false,\n\t\t\t\t\t\tindexAxis: 'y',\n\t\t\t\t\t\tplugins: {\n\t\t\t\t\t\t\tlegend: { display: false },\n\t\t\t\t\t\t\ttooltip: {\n\t\t\t\t\t\t\t\tcallbacks: {\n\t\t\t\t\t\t\t\t\tlabel: function(context) {\n\t\t\t\t\t\t\t\t\t\treturn `${context.parsed.x.toFixed(1)} hours`;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tscales: {\n\t\t\t\t\t\t\tx: { beginAtZero: true }\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tconsole.log(\"‚úÖ Team Chart: Rendered with\", topUsers.length, \"members\");\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error(\"‚ùå Team Chart: Error\", err);\n\t\t\t}\n\t\t}, 100);\n\t\t\n\t\treturn card;\n\t},\n\t\n\tcreate_profit_chart(financial) {\n\t\tconsole.log(\"üîç Dashboard: Creating profit chart\", financial);\n\t\t\n\t\tconst card = $(`\n\t\t\t<div class=\"chart-card\">\n\t\t\t\t<div class=\"chart-card-title\">üíπ ${__(\"Revenue vs Cost\")}</div>\n\t\t\t\t<div class=\"chart-container\" style=\"height: 250px;\"></div>\n\t\t\t</div>\n\t\t`);\n\t\t\n\t\tconst revenue = financial.total_revenue || 0;\n\t\tconst cost = financial.actual_cost || 0;\n\t\tconst profit = financial.gross_profit || 0;\n\t\t\n\t\tsetTimeout(() => {\n\t\t\tconst canvas = $(\"<canvas></canvas>\");\n\t\t\tcard.find(\".chart-container\").append(canvas);\n\t\t\t\n\t\t\tif (revenue === 0 && cost === 0) {\n\t\t\t\tcard.find(\".chart-container\").html(`\n\t\t\t\t\t<div class=\"text-center text-muted pt-5\">\n\t\t\t\t\t\t<p>${__(\"No financial data available\")}</p>\n\t\t\t\t\t</div>\n\t\t\t\t`);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\n\t\t\ttry {\n\t\t\t\tnew Chart(canvas[0], {\n\t\t\t\t\ttype: 'bar',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tlabels: [__('Revenue'), __('Cost'), __('Profit')],\n\t\t\t\t\t\tdatasets: [{\n\t\t\t\t\t\t\tlabel: __('Amount (SAR)'),\n\t\t\t\t\t\t\tdata: [revenue, cost, profit],\n\t\t\t\t\t\t\tbackgroundColor: ['#28a745', '#dc3545', profit >= 0 ? '#17a2b8' : '#ffc107'],\n\t\t\t\t\t\t\tborderWidth: 0\n\t\t\t\t\t\t}]\n\t\t\t\t\t},\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tresponsive: true,\n\t\t\t\t\t\tmaintainAspectRatio: false,\n\t\t\t\t\t\tplugins: {\n\t\t\t\t\t\t\tlegend: { display: false },\n\t\t\t\t\t\t\ttooltip: {\n\t\t\t\t\t\t\t\tcallbacks: {\n\t\t\t\t\t\t\t\t\tlabel: function(context) {\n\t\t\t\t\t\t\t\t\t\treturn frappe.format(context.parsed.y, {fieldtype: 'Currency'});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tscales: {\n\t\t\t\t\t\t\ty: { beginAtZero: true }\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tconsole.log(\"‚úÖ Profit Chart: Rendered\");\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error(\"‚ùå Profit Chart: Error\", err);\n\t\t\t}\n\t\t}, 100);\n\t\t\n\t\treturn card;\n\t},\n\t\n\tcreate_priority_chart(tasks) {\n\t\tconsole.log(\"üîç Dashboard: Creating priority chart\", tasks);\n\t\t\n\t\tconst card = $(`\n\t\t\t<div class=\"chart-card\">\n\t\t\t\t<div class=\"chart-card-title\">‚≠ê ${__(\"Tasks by Priority\")}</div>\n\t\t\t\t<div class=\"chart-container\" style=\"height: 250px;\"></div>\n\t\t\t</div>\n\t\t`);\n\t\t\n\t\tconst byPriority = tasks.by_priority || {};\n\t\tconst labels = Object.keys(byPriority);\n\t\tconst values = Object.values(byPriority);\n\t\t\n\t\tif (labels.length === 0) {\n\t\t\tcard.find(\".chart-container\").html(`<div class=\"text-center text-muted pt-5\">${__(\"No task data\")}</div>`);\n\t\t\treturn card;\n\t\t}\n\t\t\n\t\tsetTimeout(() => {\n\t\t\tconst canvas = $(\"<canvas></canvas>\");\n\t\t\tcard.find(\".chart-container\").append(canvas);\n\t\t\t\n\t\t\tconst colors = {\n\t\t\t\t'Urgent': '#dc3545',\n\t\t\t\t'High': '#fd7e14',\n\t\t\t\t'Medium': '#ffc107',\n\t\t\t\t'Low': '#28a745'\n\t\t\t};\n\t\t\t\n\t\t\tconst bgColors = labels.map(label => colors[label] || '#6c757d');\n\t\t\t\n\t\t\ttry {\n\t\t\t\tnew Chart(canvas[0], {\n\t\t\t\t\ttype: 'doughnut',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tlabels: labels,\n\t\t\t\t\t\tdatasets: [{\n\t\t\t\t\t\t\tdata: values,\n\t\t\t\t\t\t\tbackgroundColor: bgColors,\n\t\t\t\t\t\t\tborderWidth: 2,\n\t\t\t\t\t\t\tborderColor: '#fff'\n\t\t\t\t\t\t}]\n\t\t\t\t\t},\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tresponsive: true,\n\t\t\t\t\t\tmaintainAspectRatio: false,\n\t\t\t\t\t\tplugins: {\n\t\t\t\t\t\t\tlegend: {\n\t\t\t\t\t\t\t\tposition: 'bottom',\n\t\t\t\t\t\t\t\tlabels: { padding: 10, font: { size: 11 } }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tconsole.log(\"‚úÖ Priority Chart: Rendered\");\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error(\"‚ùå Priority Chart: Error\", err);\n\t\t\t}\n\t\t}, 100);\n\t\t\n\t\treturn card;\n\t},\n\n\tcreate_financial_chart(financial) {\n\t\tconsole.log(\"üîç Dashboard: Creating financial chart\", financial);\n\t\t\n\t\tconst card = $(`\n\t\t\t<div class=\"chart-card\">\n\t\t\t\t<div class=\"chart-card-title\">üí∞ ${__(\"Cost Breakdown\")}</div>\n\t\t\t\t<div class=\"chart-container\" style=\"height: 250px;\"></div>\n\t\t\t</div>\n\t\t`);\n\t\t\n\t\tconst breakdown = financial.breakdown || {};\n\t\tconsole.log(\"üîç Dashboard: Financial breakdown data\", breakdown);\n\t\t\n\t\tconst chartData = {\n\t\t\tlabels: [__(\"Timesheet\"), __(\"Purchases\"), __(\"Expenses\")],\n\t\t\tdatasets: [{\n\t\t\t\tdata: [\n\t\t\t\t\tbreakdown.timesheet_cost || 0,\n\t\t\t\t\tbreakdown.purchase_cost || 0,\n\t\t\t\t\tbreakdown.expense_claims || 0\n\t\t\t\t],\n\t\t\t\tbackgroundColor: ['#667eea', '#764ba2', '#f093fb']\n\t\t\t}]\n\t\t};\n\t\t\n\t\tconsole.log(\"üîç Dashboard: Chart data prepared\", chartData);\n\t\t\n\t\tsetTimeout(() => {\n\t\t\tconst canvas = $(\"<canvas></canvas>\");\n\t\t\tcard.find(\".chart-container\").append(canvas);\n\t\t\t\n\t\t\tconst total = chartData.datasets[0].data.reduce((a, b) => a + b, 0);\n\t\t\tconsole.log(\"üìä Financial Chart: Total =\", total, \"Data:\", chartData.datasets[0].data);\n\t\t\t\n\t\t\tif (total === 0) {\n\t\t\t\tcard.find(\".chart-container\").html(`\n\t\t\t\t\t<div class=\"text-center text-muted pt-5\">\n\t\t\t\t\t\t<p class=\"mb-2\">${__(\"No cost data available\")}</p>\n\t\t\t\t\t\t<small>${__(\"Costs will appear once timesheet, purchases, or expenses are logged\")}</small>\n\t\t\t\t\t</div>\n\t\t\t\t`);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\n\t\t\ttry {\n\t\t\t\tnew Chart(canvas[0], {\n\t\t\t\t\ttype: 'doughnut',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tlabels: chartData.labels,\n\t\t\t\t\t\tdatasets: [{\n\t\t\t\t\t\t\tdata: chartData.datasets[0].data,\n\t\t\t\t\t\t\tbackgroundColor: ['#667eea', '#764ba2', '#f093fb'],\n\t\t\t\t\t\t\tborderWidth: 2,\n\t\t\t\t\t\t\tborderColor: '#fff'\n\t\t\t\t\t\t}]\n\t\t\t\t\t},\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tresponsive: true,\n\t\t\t\t\t\tmaintainAspectRatio: false,\n\t\t\t\t\t\tplugins: {\n\t\t\t\t\t\t\tlegend: {\n\t\t\t\t\t\t\t\tposition: 'bottom',\n\t\t\t\t\t\t\t\tlabels: { padding: 15, font: { size: 12 } }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tconsole.log(\"‚úÖ Financial Chart: Rendered successfully\");\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error(\"‚ùå Financial Chart: Error rendering\", err);\n\t\t\t}\n\t\t}, 100);\n\t\t\n\t\treturn card;\n\t},\n\n\tcreate_task_status_chart(tasks) {\n\t\tconsole.log(\"üîç Dashboard: Creating task status chart\", tasks);\n\t\t\n\t\tconst card = $(`\n\t\t\t<div class=\"chart-card\">\n\t\t\t\t<div class=\"chart-card-title\">üìä ${__(\"Tasks by Status\")}</div>\n\t\t\t\t<div class=\"chart-container\" style=\"height: 250px;\"></div>\n\t\t\t</div>\n\t\t`);\n\t\t\n\t\tconst byStatus = tasks.by_status || {};\n\t\tconsole.log(\"üîç Dashboard: Task by_status data\", byStatus);\n\t\t\n\t\tconst labels = Object.keys(byStatus);\n\t\tconst values = Object.values(byStatus);\n\t\tconsole.log(\"üîç Dashboard: Chart labels/values\", {labels, values});\n\t\t\n\t\tsetTimeout(() => {\n\t\t\tconst canvas = $(\"<canvas></canvas>\");\n\t\t\tcard.find(\".chart-container\").append(canvas);\n\t\t\t\n\t\t\tif (labels.length === 0) {\n\t\t\t\tcard.find(\".chart-container\").html(`<div class=\"text-center text-muted pt-5\">${__(\"No task data available\")}</div>`);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\n\t\t\ttry {\n\t\t\t\tnew Chart(canvas[0], {\n\t\t\t\t\ttype: 'bar',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tlabels: labels,\n\t\t\t\t\t\tdatasets: [{\n\t\t\t\t\t\t\tlabel: __('Tasks'),\n\t\t\t\t\t\t\tdata: values,\n\t\t\t\t\t\t\tbackgroundColor: '#28a745',\n\t\t\t\t\t\t\tborderColor: '#1e7e34',\n\t\t\t\t\t\t\tborderWidth: 1\n\t\t\t\t\t\t}]\n\t\t\t\t\t},\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tresponsive: true,\n\t\t\t\t\t\tmaintainAspectRatio: false,\n\t\t\t\t\t\tplugins: {\n\t\t\t\t\t\t\tlegend: { display: false }\n\t\t\t\t\t\t},\n\t\t\t\t\t\tscales: {\n\t\t\t\t\t\t\ty: {\n\t\t\t\t\t\t\t\tbeginAtZero: true,\n\t\t\t\t\t\t\t\tticks: { stepSize: 1 }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tconsole.log(\"‚úÖ Task Status Chart: Rendered with\", labels.length, \"statuses\");\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error(\"‚ùå Task Status Chart: Error\", err);\n\t\t\t}\n\t\t}, 100);\n\t\t\n\t\treturn card;\n\t},\n\n\tcreate_cost_trend_chart(trends) {\n\t\tconst card = $(`\n\t\t\t<div class=\"chart-card\">\n\t\t\t\t<div class=\"chart-card-title\">üìà ${__(\"Cost Trend\")}</div>\n\t\t\t\t<div class=\"chart-container\" style=\"height: 250px;\"></div>\n\t\t\t</div>\n\t\t`);\n\t\t\n\t\tconst costTrend = trends.cost_trend || [];\n\t\t\n\t\tif (costTrend.length === 0) {\n\t\t\tcard.find(\".chart-container\").html(`<div class=\"text-center text-muted pt-5\">${__(\"No cost data available\")}</div>`);\n\t\t\treturn card;\n\t\t}\n\t\t\n\t\tconst labels = costTrend.map(d => frappe.datetime.str_to_user(d.date));\n\t\tconst values = costTrend.map(d => d.amount);\n\t\t\n\t\tsetTimeout(() => {\n\t\t\tconst canvas = $(\"<canvas></canvas>\");\n\t\t\tcard.find(\".chart-container\").append(canvas);\n\t\t\t\n\t\t\ttry {\n\t\t\t\tnew Chart(canvas[0], {\n\t\t\t\t\ttype: 'line',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tlabels: labels,\n\t\t\t\t\t\tdatasets: [{\n\t\t\t\t\t\t\tlabel: __('Cumulative Cost'),\n\t\t\t\t\t\t\tdata: values,\n\t\t\t\t\t\t\tborderColor: '#dc3545',\n\t\t\t\t\t\t\tbackgroundColor: 'rgba(220, 53, 69, 0.1)',\n\t\t\t\t\t\t\tborderWidth: 2,\n\t\t\t\t\t\t\tfill: true,\n\t\t\t\t\t\t\ttension: 0.4\n\t\t\t\t\t\t}]\n\t\t\t\t\t},\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tresponsive: true,\n\t\t\t\t\t\tmaintainAspectRatio: false,\n\t\t\t\t\t\tplugins: {\n\t\t\t\t\t\t\tlegend: { display: false }\n\t\t\t\t\t\t},\n\t\t\t\t\t\tscales: {\n\t\t\t\t\t\t\ty: { beginAtZero: true }\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tconsole.log(\"‚úÖ Cost Trend Chart: Rendered with\", labels.length, \"points\");\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error(\"‚ùå Cost Trend Chart: Error\", err);\n\t\t\t}\n\t\t}, 100);\n\t\t\n\t\treturn card;\n\t},\n\n\tcreate_completion_trend_chart(trends) {\n\t\tconst card = $(`\n\t\t\t<div class=\"chart-card\">\n\t\t\t\t<div class=\"chart-card-title\">‚úÖ ${__(\"Tasks Completed (Weekly)\")}</div>\n\t\t\t\t<div class=\"chart-container\" style=\"height: 250px;\"></div>\n\t\t\t</div>\n\t\t`);\n\t\t\n\t\tconst completions = trends.task_completion || [];\n\t\t\n\t\tif (completions.length === 0) {\n\t\t\tcard.find(\".chart-container\").html(`<div class=\"text-center text-muted pt-5\">${__(\"No completion data available\")}</div>`);\n\t\t\treturn card;\n\t\t}\n\t\t\n\t\tconst labels = completions.map(d => frappe.datetime.str_to_user(d.week));\n\t\tconst values = completions.map(d => d.count);\n\t\t\n\t\tsetTimeout(() => {\n\t\t\tconst canvas = $(\"<canvas></canvas>\");\n\t\t\tcard.find(\".chart-container\").append(canvas);\n\t\t\t\n\t\t\ttry {\n\t\t\t\tnew Chart(canvas[0], {\n\t\t\t\t\ttype: 'bar',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tlabels: labels,\n\t\t\t\t\t\tdatasets: [{\n\t\t\t\t\t\t\tlabel: __('Tasks Completed'),\n\t\t\t\t\t\t\tdata: values,\n\t\t\t\t\t\t\tbackgroundColor: '#17a2b8',\n\t\t\t\t\t\t\tborderColor: '#117a8b',\n\t\t\t\t\t\t\tborderWidth: 1\n\t\t\t\t\t\t}]\n\t\t\t\t\t},\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tresponsive: true,\n\t\t\t\t\t\tmaintainAspectRatio: false,\n\t\t\t\t\t\tplugins: {\n\t\t\t\t\t\t\tlegend: { display: false }\n\t\t\t\t\t\t},\n\t\t\t\t\t\tscales: {\n\t\t\t\t\t\t\ty: {\n\t\t\t\t\t\t\t\tbeginAtZero: true,\n\t\t\t\t\t\t\t\tticks: { stepSize: 1 }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tconsole.log(\"‚úÖ Completion Trend Chart: Rendered with\", labels.length, \"weeks\");\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error(\"‚ùå Completion Trend Chart: Error\", err);\n\t\t\t}\n\t\t}, 100);\n\t\t\n\t\treturn card;\n\t},\n\n\tadd_dashboard_toolbar(frm) {\n\t\t// Remove previous buttons if any\n\t\tfrm.page.remove_inner_button(\"Export PDF\", \"Dashboard\");\n\t\tfrm.page.remove_inner_button(\"Print Dashboard\");\n\t\t\n\t\t// Add export PDF button\n\t\tfrm.page.add_inner_button(__(\"Export PDF\"), () => {\n\t\t\tfrm.events.export_dashboard_pdf(frm);\n\t\t}, __(\"Dashboard\"));\n\t\t\n\t\t// Add print button\n\t\tfrm.page.add_inner_button(__(\"Print Dashboard\"), () => {\n\t\t\twindow.print();\n\t\t});\n\t},\n\t\n\texport_dashboard_pdf(frm) {\n\t\tconst data = frm.__dashboard_data;\n\t\tif (!data) {\n\t\t\tfrappe.msgprint(__(\"Please load dashboard data first\"));\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tfrappe.show_alert({\n\t\t\tmessage: __(\"Preparing PDF export...\"),\n\t\t\tindicator: \"blue\"\n\t\t});\n\t\t\n\t\t// Create printable HTML\n\t\tconst html = frm.events.generate_dashboard_html(frm, data);\n\t\t\n\t\t// Open print preview in new window\n\t\tconst printWindow = window.open('', '_blank');\n\t\tprintWindow.document.write(html);\n\t\tprintWindow.document.close();\n\t\t\n\t\t// Trigger print after a short delay to allow content to render\n\t\tsetTimeout(() => {\n\t\t\tprintWindow.print();\n\t\t}, 500);\n\t},\n\t\n\tgenerate_dashboard_html(frm, data) {\n\t\tconst financial = data.financial || {};\n\t\tconst timeline = data.timeline || {};\n\t\tconst tasks = data.tasks || {};\n\t\tconst team = data.team || {};\n\t\tconst health = data.health || {};\n\t\tconst project_info = data.project_info || {};\n\t\t\n\t\treturn `\n\t\t<!DOCTYPE html>\n\t\t<html>\n\t\t<head>\n\t\t\t<title>Project Dashboard - ${project_info.project_name || project_info.name}</title>\n\t\t\t<style>\n\t\t\t\t@media print {\n\t\t\t\t\t@page { margin: 1cm; }\n\t\t\t\t}\n\t\t\t\tbody {\n\t\t\t\t\tfont-family: Arial, sans-serif;\n\t\t\t\t\tpadding: 20px;\n\t\t\t\t\tcolor: #333;\n\t\t\t\t}\n\t\t\t\t.header {\n\t\t\t\t\ttext-align: center;\n\t\t\t\t\tborder-bottom: 3px solid #667eea;\n\t\t\t\t\tpadding-bottom: 20px;\n\t\t\t\t\tmargin-bottom: 30px;\n\t\t\t\t}\n\t\t\t\t.header h1 {\n\t\t\t\t\tmargin: 0;\n\t\t\t\t\tcolor: #667eea;\n\t\t\t\t}\n\t\t\t\t.header p {\n\t\t\t\t\tmargin: 5px 0;\n\t\t\t\t\tcolor: #666;\n\t\t\t\t}\n\t\t\t\t.kpi-grid {\n\t\t\t\t\tdisplay: grid;\n\t\t\t\t\tgrid-template-columns: repeat(3, 1fr);\n\t\t\t\t\tgap: 15px;\n\t\t\t\t\tmargin-bottom: 30px;\n\t\t\t\t}\n\t\t\t\t.kpi-box {\n\t\t\t\t\tborder: 1px solid #ddd;\n\t\t\t\t\tpadding: 15px;\n\t\t\t\t\tborder-radius: 8px;\n\t\t\t\t\ttext-align: center;\n\t\t\t\t}\n\t\t\t\t.kpi-box h3 {\n\t\t\t\t\tmargin: 0 0 10px 0;\n\t\t\t\t\tfont-size: 14px;\n\t\t\t\t\tcolor: #666;\n\t\t\t\t\tfont-weight: normal;\n\t\t\t\t}\n\t\t\t\t.kpi-box .value {\n\t\t\t\t\tfont-size: 24px;\n\t\t\t\t\tfont-weight: bold;\n\t\t\t\t\tcolor: #333;\n\t\t\t\t}\n\t\t\t\t.kpi-box .subtitle {\n\t\t\t\t\tfont-size: 12px;\n\t\t\t\t\tcolor: #999;\n\t\t\t\t\tmargin-top: 5px;\n\t\t\t\t}\n\t\t\t\t.health-section {\n\t\t\t\t\tbackground: #f8f9fa;\n\t\t\t\t\tpadding: 20px;\n\t\t\t\t\tborder-radius: 8px;\n\t\t\t\t\tmargin-bottom: 30px;\n\t\t\t\t\ttext-align: center;\n\t\t\t\t}\n\t\t\t\t.health-score {\n\t\t\t\t\tfont-size: 48px;\n\t\t\t\t\tfont-weight: bold;\n\t\t\t\t\tcolor: ${health.level === 'excellent' ? '#28a745' : health.level === 'good' ? '#17a2b8' : health.level === 'warning' ? '#ffc107' : '#dc3545'};\n\t\t\t\t}\n\t\t\t\t.section {\n\t\t\t\t\tmargin-bottom: 30px;\n\t\t\t\t\tpage-break-inside: avoid;\n\t\t\t\t}\n\t\t\t\t.section h2 {\n\t\t\t\t\tborder-bottom: 2px solid #667eea;\n\t\t\t\t\tpadding-bottom: 10px;\n\t\t\t\t\tcolor: #667eea;\n\t\t\t\t}\n\t\t\t\ttable {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\tborder-collapse: collapse;\n\t\t\t\t\tmargin-top: 10px;\n\t\t\t\t}\n\t\t\t\tth, td {\n\t\t\t\t\tpadding: 10px;\n\t\t\t\t\ttext-align: left;\n\t\t\t\t\tborder-bottom: 1px solid #ddd;\n\t\t\t\t}\n\t\t\t\tth {\n\t\t\t\t\tbackground: #f8f9fa;\n\t\t\t\t\tfont-weight: bold;\n\t\t\t\t}\n\t\t\t\t.footer {\n\t\t\t\t\tmargin-top: 40px;\n\t\t\t\t\ttext-align: center;\n\t\t\t\t\tfont-size: 12px;\n\t\t\t\t\tcolor: #999;\n\t\t\t\t\tborder-top: 1px solid #ddd;\n\t\t\t\t\tpadding-top: 20px;\n\t\t\t\t}\n\t\t\t</style>\n\t\t</head>\n\t\t<body>\n\t\t\t<div class=\"header\">\n\t\t\t\t<h1>Project Management Dashboard</h1>\n\t\t\t\t<p><strong>${project_info.project_name || project_info.name}</strong></p>\n\t\t\t\t<p>Generated on: ${new Date().toLocaleString()}</p>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div class=\"health-section\">\n\t\t\t\t<h2 style=\"margin-top:0;\">Project Health Score</h2>\n\t\t\t\t<div class=\"health-score\">${health.score || 0}/100</div>\n\t\t\t\t<p style=\"font-size:16px; margin:10px 0;\">${health.level === 'excellent' ? 'Excellent' : health.level === 'good' ? 'Good' : health.level === 'warning' ? 'Needs Attention' : 'At Risk'}</p>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div class=\"kpi-grid\">\n\t\t\t\t<div class=\"kpi-box\">\n\t\t\t\t\t<h3>üí∞ Actual Cost</h3>\n\t\t\t\t\t<div class=\"value\">${frappe.format(financial.actual_cost || 0, {fieldtype: 'Currency'})}</div>\n\t\t\t\t\t<div class=\"subtitle\">${financial.budget_variance_pct ? (financial.budget_variance_pct > 0 ? '+' : '') + financial.budget_variance_pct.toFixed(1) + '%' : ''}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"kpi-box\">\n\t\t\t\t\t<h3>üíµ Revenue</h3>\n\t\t\t\t\t<div class=\"value\">${frappe.format(financial.total_revenue || 0, {fieldtype: 'Currency'})}</div>\n\t\t\t\t\t<div class=\"subtitle\">Billed: ${frappe.format(financial.total_billed || 0, {fieldtype: 'Currency'})}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"kpi-box\">\n\t\t\t\t\t<h3>üìä Gross Profit</h3>\n\t\t\t\t\t<div class=\"value\">${frappe.format(financial.gross_profit || 0, {fieldtype: 'Currency'})}</div>\n\t\t\t\t\t<div class=\"subtitle\">${(financial.profit_margin_pct || 0).toFixed(1)}% margin</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"kpi-box\">\n\t\t\t\t\t<h3>üìÖ Timeline</h3>\n\t\t\t\t\t<div class=\"value\">${timeline.days_remaining >= 0 ? timeline.days_remaining + ' days left' : 'Completed'}</div>\n\t\t\t\t\t<div class=\"subtitle\">${(timeline.percent_complete || 0)}% complete</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"kpi-box\">\n\t\t\t\t\t<h3>‚úÖ Tasks</h3>\n\t\t\t\t\t<div class=\"value\">${tasks.completed || 0}/${tasks.total || 0}</div>\n\t\t\t\t\t<div class=\"subtitle\">${tasks.overdue ? tasks.overdue + ' overdue' : 'None overdue'}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"kpi-box\">\n\t\t\t\t\t<h3>üë• Team</h3>\n\t\t\t\t\t<div class=\"value\">${team.total_hours || 0} hrs</div>\n\t\t\t\t\t<div class=\"subtitle\">${team.team_size || 0} members</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div class=\"section\">\n\t\t\t\t<h2>Financial Breakdown</h2>\n\t\t\t\t<table>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<th>Metric</th>\n\t\t\t\t\t\t<th>Amount</th>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>Estimated Budget</td>\n\t\t\t\t\t\t<td>${frappe.format(financial.estimated_budget || 0, {fieldtype: 'Currency'})}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>Actual Cost</td>\n\t\t\t\t\t\t<td>${frappe.format(financial.actual_cost || 0, {fieldtype: 'Currency'})}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>Timesheet Cost</td>\n\t\t\t\t\t\t<td>${frappe.format(financial.breakdown?.timesheet_cost || 0, {fieldtype: 'Currency'})}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>Purchase Cost</td>\n\t\t\t\t\t\t<td>${frappe.format(financial.breakdown?.purchase_cost || 0, {fieldtype: 'Currency'})}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>Total Revenue</td>\n\t\t\t\t\t\t<td>${frappe.format(financial.total_revenue || 0, {fieldtype: 'Currency'})}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><strong>Gross Profit</strong></td>\n\t\t\t\t\t\t<td><strong>${frappe.format(financial.gross_profit || 0, {fieldtype: 'Currency'})}</strong></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</table>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div class=\"section\">\n\t\t\t\t<h2>Task Status</h2>\n\t\t\t\t<table>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<th>Status</th>\n\t\t\t\t\t\t<th>Count</th>\n\t\t\t\t\t</tr>\n\t\t\t\t\t${Object.entries(tasks.by_status || {}).map(([status, count]) => `\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<td>${status}</td>\n\t\t\t\t\t\t\t<td>${count}</td>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t`).join('')}\n\t\t\t\t</table>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div class=\"footer\">\n\t\t\t\t<p>Generated by ERPNext | ${frappe.boot.sitename}</p>\n\t\t\t</div>\n\t\t</body>\n\t\t</html>\n\t\t`;\n\t},\n\t\n\trender_tables(frm, data) {\n\t\tconst tablesDiv = $(\"<div class='dashboard-charts-grid'></div>\");\n\t\t\n\t\t// Overdue Tasks Table\n\t\tconst overdueCard = frm.events.create_overdue_tasks_table(data.tasks);\n\t\ttablesDiv.append(overdueCard);\n\t\t\n\t\t// Milestones Table\n\t\tconst milestoneCard = frm.events.create_milestone_summary(data.timeline);\n\t\ttablesDiv.append(milestoneCard);\n\t\t\n\t\treturn tablesDiv;\n\t},\n\n\tcreate_overdue_tasks_table(tasks) {\n\t\tconst card = $(`\n\t\t\t<div class=\"chart-card\">\n\t\t\t\t<div class=\"chart-card-title\">‚ö†Ô∏è ${__(\"Overdue Tasks\")}</div>\n\t\t\t\t<div class=\"table-container\"></div>\n\t\t\t</div>\n\t\t`);\n\t\t\n\t\tconst overdueTasks = tasks.overdue_tasks || [];\n\t\t\n\t\tif (overdueTasks.length === 0) {\n\t\t\tcard.find(\".table-container\").html(`<div class=\"text-center text-muted py-4\">${__(\"No overdue tasks\")}</div>`);\n\t\t\treturn card;\n\t\t}\n\t\t\n\t\tconst table = $(`\n\t\t\t<table class=\"dashboard-table\">\n\t\t\t\t<thead>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<th>${__(\"Task\")}</th>\n\t\t\t\t\t\t<th>${__(\"Due Date\")}</th>\n\t\t\t\t\t\t<th>${__(\"Priority\")}</th>\n\t\t\t\t\t</tr>\n\t\t\t\t</thead>\n\t\t\t\t<tbody></tbody>\n\t\t\t</table>\n\t\t`);\n\t\t\n\t\tconst tbody = table.find(\"tbody\");\n\t\toverdueTasks.forEach(task => {\n\t\t\tconst row = $(`\n\t\t\t\t<tr style=\"cursor: pointer;\">\n\t\t\t\t\t<td><a href=\"/app/task/${task.name}\">${task.name}</a></td>\n\t\t\t\t\t<td>${frappe.datetime.str_to_user(task.exp_end_date)}</td>\n\t\t\t\t\t<td><span class=\"badge bg-${task.priority === 'High' || task.priority === 'Urgent' ? 'danger' : 'warning'}\">${task.priority}</span></td>\n\t\t\t\t</tr>\n\t\t\t`);\n\t\t\trow.on(\"click\", () => frappe.set_route(\"Form\", \"Task\", task.name));\n\t\t\ttbody.append(row);\n\t\t});\n\t\t\n\t\tcard.find(\".table-container\").append(table);\n\t\treturn card;\n\t},\n\n\tcreate_milestone_summary(timeline) {\n\t\tconst card = $(`\n\t\t\t<div class=\"chart-card\">\n\t\t\t\t<div class=\"chart-card-title\">üéØ ${__(\"Milestones\")}</div>\n\t\t\t\t<div class=\"milestone-summary\"></div>\n\t\t\t</div>\n\t\t`);\n\t\t\n\t\tconst milestones = timeline.milestones || {};\n\t\tconst total = milestones.total || 0;\n\t\tconst completed = milestones.completed || 0;\n\t\tconst pending = milestones.pending || 0;\n\t\t\n\t\tconst summary = $(`\n\t\t\t<div>\n\t\t\t\t<div class=\"d-flex justify-content-between mb-3\">\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<div class=\"h2 mb-0\">${completed}/${total}</div>\n\t\t\t\t\t\t<small class=\"text-muted\">${__(\"Completed\")}</small>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"text-end\">\n\t\t\t\t\t\t<div class=\"h2 mb-0 text-warning\">${pending}</div>\n\t\t\t\t\t\t<small class=\"text-muted\">${__(\"Pending\")}</small>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"mini-progress\">\n\t\t\t\t\t<div class=\"mini-progress-bar\" style=\"width: ${total ? (completed / total * 100) : 0}%\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"text-center mt-2 small text-muted\">\n\t\t\t\t\t${total ? ((completed / total * 100).toFixed(0)) : 0}% ${__(\"milestone completion\")}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`);\n\t\t\n\t\tcard.find(\".milestone-summary\").append(summary);\n\t\treturn card;\n\t},\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-08-04 14:27:50.016300",
  "module": null,
  "name": "po script",
  "script": "frappe.ui.form.on('Purchase Order', {\n\trefresh(frm) {\n\t\tfrm.add_custom_button(\n        __('Populate From Items'),\n        function() {\n          if (!frm.doc.items || frm.doc.items.length === 0) {\n            frappe.msgprint(__('No items found to generate schedule.'));\n            return;\n          }\n          // Clear existing schedule rows\n          frm.clear_table('payment_schedule');\n\n          // Sequential monthly schedule based on posting date\n          let current = frm.doc.posting_date || frm.doc.transaction_date;\n          frm.doc.items.forEach(item => {\n            const row = frm.add_child('payment_schedule');\n            // Start date for this task\n            row.start_date = current;\n            // Calculate due_date one month after start_date\n            const nextDue = frappe.datetime.add_months(current, 1);\n            row.due_date = nextDue;\n            row.payment_amount = flt(item.qty) * flt(item.rate);\n            row.description = `${item.item_code} ‚Äì ${item.description || item.item_name}`;\n            // Next task starts when this one ends\n            current = nextDue;\n          });\n\n          // Refresh table and notify\n          frm.refresh_field('payment_schedule');\n          frappe.msgprint(__('Payment Schedule populated sequentially from posting date.'));\n        }\n      );\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2025-08-19 11:17:43.067990",
  "module": null,
  "name": "Employee Code",
  "script": "frappe.ui.form.on('Employee', {\n\trefresh(frm) {\n\t\trecalc_residence_total(frm); // keep UI consistent on load\n\t},\n\n\t// Fired when a row is added to the child table\n\tcustom_residence_costs_add(frm) {\n\t\trecalc_residence_total(frm);\n\t}\n});\n\n// Trigger on edits inside the child table rows\nfrappe.ui.form.on('Residence Costs', {\n\tamount(frm, cdt, cdn) {\n\t\trecalc_residence_total(frm);\n\t},\n\ttransaction_date(frm, cdt, cdn) {\n\t\t// optional: only if you want any change to prompt recompute\n\t\trecalc_residence_total(frm);\n\t},\n\tresidence_costs(frm, cdt, cdn) {\n\t\t// optional: same note as above\n\t\trecalc_residence_total(frm);\n\t},\n\t// Fired when a row is removed from the child table\n\tcustom_residence_costs_remove(frm, cdt, cdn) {\n\t\trecalc_residence_total(frm);\n\t}\n});\n\nfunction recalc_residence_total(frm) {\n\tlet total = 0.0;\n\t(frm.doc.custom_residence_costs || []).forEach(r => {\n\t\ttotal += flt(r.amount || 0);\n\t});\n\tfrm.set_value('custom_total_cost', total);\n\tfrm.refresh_field('custom_total_cost');\n}\n\n// frappe.utils.flt helper for consistency with backend rounding\nfunction flt(val, precision) {\n\tconst p = (typeof precision === 'number') ? precision : 2;\n\tlet n = parseFloat(val);\n\tif (isNaN(n)) n = 0;\n\treturn parseFloat(n.toFixed(p));\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Payroll Entry",
  "enabled": 1,
  "modified": "2025-08-26 14:23:25.542355",
  "module": null,
  "name": "payroll print",
  "script": "frappe.ui.form.on('Payroll Entry', {\n  refresh(frm) {\n    // Only show on Submitted (change to !== 0 if you also want Draft)\n    if (frm.doc.docstatus !== 1) return;\n\n    // --- Helper: POST to an endpoint and open in a new tab (with CSRF) ---\n    const open_post = (url, params = {}) => {\n      const form = document.createElement('form');\n      form.method = 'POST';\n      form.action = url;\n      form.target = '_blank';\n\n      // include CSRF token so Frappe accepts the POST\n      const fields = { csrf_token: frappe.csrf_token, ...params };\n      Object.entries(fields).forEach(([k, v]) => {\n        const input = document.createElement('input');\n        input.type = 'hidden';\n        input.name = k;\n        input.value = typeof v === 'string' ? v : JSON.stringify(v);\n        form.appendChild(input);\n      });\n\n      document.body.appendChild(form);\n      form.submit();\n      form.remove();\n    };\n\n    const group = __('Cairo PDF');\n\n    // Build employee list once\n    const employees = (frm.doc.employees || []).map(r => r.employee).filter(Boolean);\n\n    // A) Custom report PDF (your HTML/CSS via milestoneksa.api.pdf.download_salary_report_pdf)\n    frm.add_custom_button(__('Salary Register (Cairo PDF)'), () => {\n      const filters = {\n        company: frm.doc.company,\n        from_date: frm.doc.start_date || frm.doc.from_date,\n        to_date: frm.doc.end_date || frm.doc.to_date,\n        payroll_frequency: frm.doc.payroll_frequency,\n        payroll_entry: frm.doc.name,\n        employee_list: employees, // server will post-filter rows if needed\n      };\n\n      open_post('/api/method/milestoneksa.api.pdf.download_salary_report_pdf', {\n        report_name: 'Salary Register', // change if you want another report\n        filters: JSON.stringify(filters),\n      });\n    }, group);\n\n    // B) Merge all Salary Slips for this Payroll Entry using your Cairo print format\n    frm.add_custom_button(__('All Salary Slips (Cairo Print)'), () => {\n      open_post('/api/method/frappe.utils.print_format.download_multi_pdf', {\n        doctype: 'Salary Slip',\n        filters: JSON.stringify([['payroll_entry', '=', frm.doc.name]]),\n        print_format: 'Salary Slip - Cairo',\n        no_letterhead: 0,\n        orientation: 'Portrait',\n      });\n    }, group);\n  },\n});\n",
  "view": "Form"
 }
]