[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Project",
  "enabled": 1,
  "modified": "2025-11-09 17:15:12.871588",
  "module": "Milestoneksa",
  "name": "Project Task Tab",
  "script": "frappe.ui.form.on(\"Project\", {\n\t// ==========================================================\n\t// Project Task Tab Debug Marker\n\t// ==========================================================\n\t// If you do NOT see these logs in browser console, this file is NOT being executed\n\t// (likely because a \"Client Script\" is overriding the behavior).\n\t// ==========================================================\n\t__mks_task_tab_version: \"2026-01-18T00:00Z-task-tab-delete+select\",\n\n\trefresh(frm) {\n\t\ttry {\n\t\t\tconsole.log(\n\t\t\t\t\"[MKS][TASK TAB] refresh\",\n\t\t\t\t{\n\t\t\t\t\tproject: frm?.doc?.name,\n\t\t\t\t\tis_new: frm?.is_new?.(),\n\t\t\t\t\tversion: frm?.events?.__mks_task_tab_version,\n\t\t\t\t}\n\t\t\t);\n\t\t} catch (e) {\n\t\t\t// noop\n\t\t}\n\t\t// Add custom button in form toolbar\n\t\tif (!frm.is_new()) {\n\t\t\tfrm.add_custom_button(__(\"Sync Tasks\"), () => {\n\t\t\t\tfrm.events.render_project_task_tab(frm);\n\t\t\t\tfrappe.show_alert({\n\t\t\t\t\tmessage: __(\"Task table synced\"),\n\t\t\t\t\tindicator: \"green\"\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t\t\n\t\tfrm.events.render_project_task_tab(frm);\n\t},\n\n\tafter_save(frm) {\n\t\ttry {\n\t\t\tconsole.log(\n\t\t\t\t\"[MKS][TASK TAB] after_save\",\n\t\t\t\t{ project: frm?.doc?.name, version: frm?.events?.__mks_task_tab_version }\n\t\t\t);\n\t\t} catch (e) {\n\t\t\t// noop\n\t\t}\n\t\tfrm.events.render_project_task_tab(frm);\n\t},\n\n\trender_project_task_tab(frm) {\n\t\tconsole.log(\"[MKS][TASK TAB] Starting render\", {\n\t\t\tproject: frm?.doc?.name,\n\t\t\tversion: frm?.events?.__mks_task_tab_version,\n\t\t\tfields_available: Object.keys(frm.fields_dict || {}),\n\t\t});\n\t\t\n\t\tconst field = frm.fields_dict.custom_project_tasks_html;\n\t\tif (!field) {\n\t\t\tconsole.warn(\"[MKS][TASK TAB] HTML field 'custom_project_tasks_html' not found!\", {\n\t\t\t\tversion: frm?.events?.__mks_task_tab_version,\n\t\t\t});\n\t\t\tfrappe.msgprint({\n\t\t\t\ttitle: __(\"Debug Info\"),\n\t\t\t\tmessage: __(\"Custom field 'custom_project_tasks_html' not found. Please reload the page.\"),\n\t\t\t\tindicator: \"orange\"\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconsole.log(\"[MKS][TASK TAB] Field found, rendering table...\", {\n\t\t\tversion: frm?.events?.__mks_task_tab_version,\n\t\t});\n\n\t\tconst wrapper = field.$wrapper;\n\t\twrapper.empty().addClass(\"project-task-tab-wrapper\").css({\n\t\t\t\"padding\": \"15px\",\n\t\t\t\"background\": \"#ffffff\",\n\t\t\t\"min-height\": \"400px\"\n\t\t});\n\n\t\tif (frm.is_new()) {\n\t\t\twrapper.append(\n\t\t\t\t$(\"<div class='text-muted small mt-2'>\")\n\t\t\t\t\t.text(__(\"Save the project to manage tasks from this tab.\"))\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\t// Track selected tasks explicitly (prevents accidental delete when DOM state is wrong)\n\t\tfrm.__selected_task_names = new Set();\n\n\t\tconst header = $(`\n\t\t\t<style>\n\t\t\t\t.project-tasks-header {\n\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\tpadding: 20px;\n\t\t\t\t\tborder-radius: 8px;\n\t\t\t\t\tcolor: white;\n\t\t\t\t\tmargin: 0 0 20px 0;\n\t\t\t\t\tbox-shadow: 0 2px 8px rgba(0,0,0,0.1);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-tasks-header .h6 {\n\t\t\t\t\tcolor: white;\n\t\t\t\t\tfont-size: 18px;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t\tmargin-bottom: 5px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-tasks-header small {\n\t\t\t\t\tcolor: rgba(255,255,255,0.9);\n\t\t\t\t\tfont-size: 12px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-tasks-header .btn {\n\t\t\t\t\tborder: 1px solid rgba(255,255,255,0.3);\n\t\t\t\t\tbackground: rgba(255,255,255,0.15);\n\t\t\t\t\tcolor: white;\n\t\t\t\t\tbackdrop-filter: blur(10px);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-tasks-header .btn:hover {\n\t\t\t\t\tbackground: rgba(255,255,255,0.25);\n\t\t\t\t\tborder-color: rgba(255,255,255,0.5);\n\t\t\t\t\ttransform: translateY(-2px);\n\t\t\t\t\tbox-shadow: 0 4px 12px rgba(0,0,0,0.2);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-tasks-header .btn-primary {\n\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\tborder: 1px solid white;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-tasks-header .btn-primary:hover {\n\t\t\t\t\tbackground: linear-gradient(135deg, #764ba2 0%, #667eea 100%);\n\t\t\t\t\tbox-shadow: 0 4px 12px rgba(255,255,255,0.3);\n\t\t\t\t}\n\t\t\t</style>\n\t\t\t<div class=\"d-flex justify-content-between align-items-center mb-3 project-tasks-header\">\n\t\t\t\t<div>\n\t\t\t\t\t<div class=\"h6 mb-0\">üìã ${__(\"Project Tasks\")}\n\t\t\t\t\t\t<span class=\"badge bg-dark ms-2\" style=\"font-size: 10px; opacity: 0.85;\">\n\t\t\t\t\t\t\tMKS <span data-role=\"mks-task-tab-version\">unknown</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<small>${__(\"Click cells with üìù to edit inline. Parent tasks (blue) auto-update from children.\")}</small>\n\t\t\t\t</div>\n\t\t\t\t<div>\n\t\t\t\t\t<button class=\"btn btn-sm btn-danger me-2\" data-role=\"delete-selected\" title=\"${__(\"Delete Selected Tasks\")}\">\n\t\t\t\t\t\t<svg class=\"icon icon-sm\"><use href=\"#icon-delete\"></use></svg> ${__(\"Delete Selected\")}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class=\"btn btn-sm btn-light me-1\" data-role=\"expand-all\" title=\"${__(\"Expand All\")}\">\n\t\t\t\t\t\t‚ñº ${__(\"Expand\")}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class=\"btn btn-sm btn-light me-2\" data-role=\"collapse-all\" title=\"${__(\"Collapse All\")}\">\n\t\t\t\t\t\t‚ñ∂ ${__(\"Collapse\")}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class=\"btn btn-sm btn-success\" data-role=\"recalc-parents\">\n\t\t\t\t\t\t<svg class=\"icon icon-sm\"><use href=\"#icon-refresh\"></use></svg> ${__(\"Recalc Parents\")}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class=\"btn btn-sm btn-primary\" data-role=\"add-task\">\n\t\t\t\t\t\t<svg class=\"icon icon-sm\"><use href=\"#icon-add\"></use></svg> ${__(\"Add Task\")}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class=\"btn btn-sm btn-secondary\" data-role=\"refresh-tasks\">\n\t\t\t\t\t\t<svg class=\"icon icon-sm\"><use href=\"#icon-refresh\"></use></svg> ${__(\"Refresh\")}\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`);\n\n\t\tconst tableWrapper = $(`\n\t\t\t<style>\n\t\t\t\t/* Enhanced table wrapper */\n\t\t\t\t.project-task-tab-wrapper {\n\t\t\t\t\tfont-family: 'Cairo', sans-serif !important;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-tab-wrapper * {\n\t\t\t\t\tfont-family: 'Cairo', sans-serif !important;\n\t\t\t\t}\n\n\t\t\t\t/* Table styling */\n\t\t\t\t.project-task-table-wrapper {\n\t\t\t\t\tborder-radius: 8px;\n\t\t\t\t\toverflow: visible;\n\t\t\t\t\tbox-shadow: 0 1px 3px rgba(0,0,0,0.08);\n\t\t\t\t\tmargin: 0;\n\t\t\t\t\twidth: 100%;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.table-responsive {\n\t\t\t\t\tborder-radius: 8px;\n\t\t\t\t\tborder: 1px solid #dee2e6;\n\t\t\t\t\toverflow-x: auto;\n\t\t\t\t\toverflow-y: auto;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .table {\n\t\t\t\t\tmargin-bottom: 0;\n\t\t\t\t\tfont-size: 13px;\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\ttable-layout: auto;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Header styling */\n\t\t\t\t.project-task-table-wrapper .table thead th {\n\t\t\t\t\tbackground: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);\n\t\t\t\t\tborder-bottom: 2px solid #dee2e6;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t\tfont-size: 12px;\n\t\t\t\t\ttext-transform: uppercase;\n\t\t\t\t\tletter-spacing: 0.3px;\n\t\t\t\t\tcolor: #495057;\n\t\t\t\t\tpadding: 12px 8px;\n\t\t\t\t\twhite-space: nowrap;\n\t\t\t\t\tposition: sticky;\n\t\t\t\t\ttop: 0;\n\t\t\t\t\tz-index: 10;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Editable cells */\n\t\t\t\t.editable-cell { \n\t\t\t\t\tcursor: pointer; \n\t\t\t\t\tbackground-color: #f8f9fa;\n\t\t\t\t\ttransition: all 0.2s ease;\n\t\t\t\t\tposition: relative;\n\t\t\t\t\tborder-left: 2px solid transparent;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.editable-cell:hover { \n\t\t\t\t\tbackground-color: #fff3cd;\n\t\t\t\t\tborder-left-color: #ffc107;\n\t\t\t\t\tbox-shadow: inset 0 0 0 1px #ffc107;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.editable-cell::after {\n\t\t\t\t\tcontent: '‚úé';\n\t\t\t\t\tposition: absolute;\n\t\t\t\t\tright: 4px;\n\t\t\t\t\ttop: 50%;\n\t\t\t\t\ttransform: translateY(-50%);\n\t\t\t\t\topacity: 0;\n\t\t\t\t\tfont-size: 10px;\n\t\t\t\t\tcolor: #6c757d;\n\t\t\t\t\ttransition: opacity 0.2s;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.editable-cell:hover::after {\n\t\t\t\t\topacity: 0.6;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Parent task rows */\n\t\t\t\t.table-primary { \n\t\t\t\t\tbackground: linear-gradient(90deg, #e7f3ff 0%, #d4e9ff 100%) !important;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t\tborder-left: 4px solid #0d6efd !important;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.table-primary:hover {\n\t\t\t\t\tbackground: linear-gradient(90deg, #d4e9ff 0%, #c5e2ff 100%) !important;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Row hover effects */\n\t\t\t\t.project-task-table-wrapper .table tbody tr {\n\t\t\t\t\ttransition: all 0.15s ease;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .table tbody tr:hover {\n\t\t\t\t\tbackground-color: #f8f9fa;\n\t\t\t\t\ttransform: scale(1.001);\n\t\t\t\t\tbox-shadow: 0 2px 4px rgba(0,0,0,0.06);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Task subject link */\n\t\t\t\t.task-subject a {\n\t\t\t\t\tcolor: #0d6efd;\n\t\t\t\t\ttext-decoration: none;\n\t\t\t\t\ttransition: color 0.2s;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.task-subject a:hover {\n\t\t\t\t\tcolor: #0a58ca;\n\t\t\t\t\ttext-decoration: underline;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.table-primary .task-subject a {\n\t\t\t\t\tcolor: #084298;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* WBS badge */\n\t\t\t\t.project-task-table-wrapper td:nth-child(3) {\n\t\t\t\t\tfont-family: 'Cairo', sans-serif !important;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t\tcolor: #6c757d;\n\t\t\t\t\tfont-size: 11px;\n\t\t\t\t}\n\n\t\t\t\t/* Task subject cell should match Cairo */\n\t\t\t\t.project-task-table-wrapper .task-subject,\n\t\t\t\t.project-task-table-wrapper .task-subject a {\n\t\t\t\t\tfont-family: 'Cairo', sans-serif !important;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Status badges */\n\t\t\t\t.project-task-table-wrapper td[data-field=\"status\"] {\n\t\t\t\t\tfont-weight: 500;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Actual date columns - green highlight */\n\t\t\t\t.project-task-table-wrapper td[data-field=\"custom_actual_start_date\"],\n\t\t\t\t.project-task-table-wrapper td[data-field=\"custom_actual_end_date\"] {\n\t\t\t\t\tbackground-color: #f0f9ff !important;\n\t\t\t\t\tborder-left: 2px solid #17a2b8;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper td[data-field=\"custom_actual_start_date\"]:hover,\n\t\t\t\t.project-task-table-wrapper td[data-field=\"custom_actual_end_date\"]:hover {\n\t\t\t\t\tbackground-color: #d1f2eb !important;\n\t\t\t\t\tborder-left-color: #20c997;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Action buttons */\n\t\t\t\t.project-task-table-wrapper .btn-link {\n\t\t\t\t\tcolor: #6c757d;\n\t\t\t\t\ttransition: all 0.2s;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .btn-link:hover {\n\t\t\t\t\tcolor: #0d6efd;\n\t\t\t\t\ttransform: scale(1.2);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Collapse triangle */\n\t\t\t\t.collapse-triangle {\n\t\t\t\t\tdisplay: inline-block;\n\t\t\t\t\twidth: 16px;\n\t\t\t\t\theight: 16px;\n\t\t\t\t\tline-height: 16px;\n\t\t\t\t\ttext-align: center;\n\t\t\t\t\tcursor: pointer;\n\t\t\t\t\tuser-select: none;\n\t\t\t\t\ttransition: transform 0.3s ease;\n\t\t\t\t\tcolor: #0d6efd;\n\t\t\t\t\tfont-weight: bold;\n\t\t\t\t\tmargin-right: 8px;\n\t\t\t\t\tborder-radius: 3px;\n\t\t\t\t\tbackground: rgba(13, 110, 253, 0.1);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.collapse-triangle:hover {\n\t\t\t\t\tbackground: rgba(13, 110, 253, 0.2);\n\t\t\t\t\ttransform: scale(1.2);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.collapse-triangle.collapsed {\n\t\t\t\t\ttransform: rotate(-90deg);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.collapse-triangle.collapsed:hover {\n\t\t\t\t\ttransform: rotate(-90deg) scale(1.2);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Child task rows */\n\t\t\t\t.child-task.hidden-by-collapse {\n\t\t\t\t\tdisplay: none !important;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Loading and empty states */\n\t\t\t\t[data-role=\"loading\"], [data-role=\"empty\"] {\n\t\t\t\t\tpadding: 40px;\n\t\t\t\t\ttext-align: center;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Input fields in edit mode */\n\t\t\t\t.editable-cell .form-control-sm {\n\t\t\t\t\tborder: 2px solid #0d6efd;\n\t\t\t\t\tbox-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Button styling */\n\t\t\t\t.project-task-tab-wrapper .btn {\n\t\t\t\t\ttransition: all 0.2s ease;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-tab-wrapper .btn:hover {\n\t\t\t\t\ttransform: translateY(-1px);\n\t\t\t\t\tbox-shadow: 0 2px 4px rgba(0,0,0,0.15);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Responsive table scroll */\n\t\t\t\t.project-task-table-wrapper .table-responsive {\n\t\t\t\t\tmax-height: 70vh;\n\t\t\t\t\toverflow-x: auto;\n\t\t\t\t\toverflow-y: auto;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .table-responsive::-webkit-scrollbar {\n\t\t\t\t\twidth: 10px;\n\t\t\t\t\theight: 10px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .table-responsive::-webkit-scrollbar-track {\n\t\t\t\t\tbackground: #f1f1f1;\n\t\t\t\t\tborder-radius: 5px;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .table-responsive::-webkit-scrollbar-thumb {\n\t\t\t\t\tbackground: linear-gradient(180deg, #888 0%, #666 100%);\n\t\t\t\t\tborder-radius: 5px;\n\t\t\t\t\tborder: 2px solid #f1f1f1;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .table-responsive::-webkit-scrollbar-thumb:hover {\n\t\t\t\t\tbackground: linear-gradient(180deg, #555 0%, #333 100%);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Ensure content isn't cut off */\n\t\t\t\t.project-task-tab-wrapper {\n\t\t\t\t\toverflow: visible !important;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.project-task-table-wrapper .table td,\n\t\t\t\t.project-task-table-wrapper .table th {\n\t\t\t\t\tpadding: 10px 8px;\n\t\t\t\t\tvertical-align: middle;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Checkbox styling */\n\t\t\t\t.task-checkbox {\n\t\t\t\t\tcursor: pointer;\n\t\t\t\t\twidth: 18px;\n\t\t\t\t\theight: 18px;\n\t\t\t\t\tvertical-align: middle;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.task-row-selected {\n\t\t\t\t\tbackground-color: #fff3cd !important;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.task-row-selected:hover {\n\t\t\t\t\tbackground-color: #ffe69c !important;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t/* Minimum column widths */\n\t\t\t\t.project-task-table-wrapper th:nth-child(1) { min-width: 40px; }\n\t\t\t\t.project-task-table-wrapper th:nth-child(2) { min-width: 220px; }\n\t\t\t\t.project-task-table-wrapper th:nth-child(3) { min-width: 60px; }\n\t\t\t\t.project-task-table-wrapper th:nth-child(4) { min-width: 120px; }\n\t\t\t\t.project-task-table-wrapper th:nth-child(5) { min-width: 100px; }\n\t\t\t\t.project-task-table-wrapper th:nth-child(6) { min-width: 130px; }\n\t\t\t\t.project-task-table-wrapper th:nth-child(7) { min-width: 130px; }\n\t\t\t\t.project-task-table-wrapper th:nth-child(10) { min-width: 130px; }\n\t\t\t\t.project-task-table-wrapper th:nth-child(11) { min-width: 130px; }\n\t\t\t</style>\n\t\t\t<div class=\"table-responsive project-task-table-wrapper\">\n\t\t\t\t<table class=\"table table-bordered table-sm align-middle mb-0\">\n\t\t\t\t\t<thead class=\"table-light\">\n\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t<th style=\"min-width: 40px; text-align: center;\">\n\t\t\t\t\t\t\t\t<input type=\"checkbox\" class=\"task-checkbox\" data-role=\"select-all\" title=\"${__(\"Select All\")}\">\n\t\t\t\t\t\t\t</th>\n\t\t\t\t\t\t\t<th style=\"min-width: 220px;\">\n\t\t\t\t\t\t\t\t<svg class=\"icon icon-sm text-primary\"><use href=\"#icon-task\"></use></svg>\n\t\t\t\t\t\t\t\t${__(\"Task Name\")}\n\t\t\t\t\t\t\t</th>\n\t\t\t\t\t\t\t<th><span class=\"badge bg-secondary\">WBS</span></th>\n\t\t\t\t\t\t\t<th>üìä ${__(\"Status\")} üìù</th>\n\t\t\t\t\t\t\t<th>‚≠ê ${__(\"Priority\")} üìù</th>\n\t\t\t\t\t\t\t<th>üìÖ ${__(\"Planned Start\")} üìù</th>\n\t\t\t\t\t\t\t<th>üèÅ ${__(\"Planned Finish\")} üìù</th>\n\t\t\t\t\t\t\t<th>‚è±Ô∏è ${__(\"Duration\")}</th>\n\t\t\t\t\t\t\t<th>üïê ${__(\"Planned Hours\")} üìù</th>\n\t\t\t\t\t\t\t<th style=\"background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); font-weight: 700;\">\n\t\t\t\t\t\t\t\t‚úÖ ${__(\"Actual Start\")} üìù\n\t\t\t\t\t\t\t</th>\n\t\t\t\t\t\t\t<th style=\"background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); font-weight: 700;\">\n\t\t\t\t\t\t\t\t‚úÖ ${__(\"Actual End\")} üìù\n\t\t\t\t\t\t\t</th>\n\t\t\t\t\t\t\t<th>üìè ${__(\"Actual Duration\")}</th>\n\t\t\t\t\t\t\t<th>‚è∞ ${__(\"Actual Hours\")}</th>\n\t\t\t\t\t\t\t<th>üí∞ ${__(\"Actual Cost\")}</th>\n\t\t\t\t\t\t\t<th class=\"text-center\" style=\"min-width: 90px;\">‚öôÔ∏è ${__(\"Actions\")}</th>\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</thead>\n\t\t\t\t\t<tbody></tbody>\n\t\t\t\t</table>\n\t\t\t</div>\n\t\t`);\n\n\t\tconst emptyState = $(`\n\t\t\t<div class=\"alert alert-light border mt-3 mb-0 d-none text-center\" data-role=\"empty\" style=\"padding: 60px; border-radius: 8px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);\">\n\t\t\t\t<svg class=\"icon icon-xl text-muted mb-3\" style=\"width: 64px; height: 64px;\"><use href=\"#icon-task\"></use></svg>\n\t\t\t\t<h5 class=\"text-muted\">${__(\"No Tasks Yet\")}</h5>\n\t\t\t\t<p class=\"text-muted mb-0\">${__(\"Use the Add Task button above to create your first task for this project.\")}</p>\n\t\t\t</div>\n\t\t`);\n\n\t\tconst loadingState = $(`\n\t\t\t<div class=\"text-center mt-5 mb-5\" data-role=\"loading\">\n\t\t\t\t<div class=\"spinner-border text-primary\" role=\"status\" style=\"width: 3rem; height: 3rem;\">\n\t\t\t\t\t<span class=\"visually-hidden\">${__(\"Loading...\")}</span>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"mt-3 text-muted\">${__(\"Loading tasks...\")}</div>\n\t\t\t</div>\n\t\t`);\n\n\t\twrapper.append(header, tableWrapper, emptyState, loadingState);\n\t\t\n\t\t// Set visible version label (template string cannot safely interpolate frm)\n\t\ttry {\n\t\t\tconst v = frm?.events?.__mks_task_tab_version || \"unknown\";\n\t\t\theader.find('[data-role=\"mks-task-tab-version\"]').text(v);\n\t\t} catch (e) {\n\t\t\t// noop\n\t\t}\n\t\tconsole.log(\"[MKS][TASK TAB] Header + Table injected into DOM\", {\n\t\t\tversion: frm?.events?.__mks_task_tab_version,\n\t\t\thas_delete_selected_btn: header.find(\"[data-role='delete-selected']\").length,\n\t\t\thas_select_all: wrapper.find(\"[data-role='select-all']\").length,\n\t\t});\n\n\t\theader.find(\"[data-role='add-task']\").on(\"click\", () => {\n\t\t\tfrm.events.open_project_task_dialog(frm);\n\t\t});\n\n\t\theader.find(\"[data-role='refresh-tasks']\").on(\"click\", () => {\n\t\t\tfrm.events.load_project_tasks(frm);\n\t\t});\n\t\t\n\t\theader.find(\"[data-role='recalc-parents']\").on(\"click\", () => {\n\t\t\tfrm.events.recalculate_all_parents(frm);\n\t\t});\n\t\t\n\t\theader.find(\"[data-role='expand-all']\").on(\"click\", () => {\n\t\t\tfrm.events.expand_all_tasks(frm);\n\t\t});\n\t\t\n\t\theader.find(\"[data-role='collapse-all']\").on(\"click\", () => {\n\t\t\tfrm.events.collapse_all_tasks(frm);\n\t\t});\n\t\t\n\t\theader.find(\"[data-role='delete-selected']\").on(\"click\", () => {\n\t\t\tconsole.log(\"[MKS][TASK TAB] delete-selected clicked\", {\n\t\t\t\tversion: frm?.events?.__mks_task_tab_version,\n\t\t\t});\n\t\t\tfrm.events.delete_selected_tasks(frm);\n\t\t});\n\t\t\n\t\t// Select all checkbox handler\n\t\twrapper.on(\"change\", \"[data-role='select-all']\", function() {\n\t\t\tconst isChecked = $(this).prop(\"checked\");\n\t\t\tconsole.log(\"[MKS][TASK TAB] select-all changed\", {\n\t\t\t\tchecked: isChecked,\n\t\t\t\tversion: frm?.events?.__mks_task_tab_version,\n\t\t\t});\n\t\t\t// Update all row checkboxes and selection Set\n\t\t\twrapper.find(\".task-row-checkbox\").prop(\"checked\", isChecked).trigger(\"change\");\n\t\t});\n\n\t\tfrm.events.load_project_tasks(frm);\n\t},\n\t\n\texpand_all_tasks(frm) {\n\t\tconst taskMap = frm.__task_hierarchy || {};\n\t\tObject.values(taskMap).forEach(task => {\n\t\t\tif (task.children && task.children.length > 0) {\n\t\t\t\ttask.expanded = true;\n\t\t\t\tconst row = $(`tr[data-task=\"${task.name}\"]`);\n\t\t\t\tconst triangle = row.find(\".collapse-triangle\");\n\t\t\t\ttriangle.removeClass(\"collapsed\");\n\t\t\t\trow.removeClass(\"collapsed\");\n\t\t\t}\n\t\t});\n\t\t$(\"tr.child-task\").removeClass(\"hidden-by-collapse\").fadeIn(200);\n\t\tfrappe.show_alert({ message: __(\"All tasks expanded\"), indicator: \"blue\" }, 2);\n\t},\n\t\n\tcollapse_all_tasks(frm) {\n\t\tconst taskMap = frm.__task_hierarchy || {};\n\t\tObject.values(taskMap).forEach(task => {\n\t\t\tif (task.children && task.children.length > 0) {\n\t\t\t\ttask.expanded = false;\n\t\t\t\tconst row = $(`tr[data-task=\"${task.name}\"]`);\n\t\t\t\tconst triangle = row.find(\".collapse-triangle\");\n\t\t\t\ttriangle.addClass(\"collapsed\");\n\t\t\t\trow.addClass(\"collapsed\");\n\t\t\t}\n\t\t});\n\t\t$(\"tr.child-task\").addClass(\"hidden-by-collapse\").fadeOut(200);\n\t\tfrappe.show_alert({ message: __(\"All tasks collapsed\"), indicator: \"blue\" }, 2);\n\t},\n\t\n\trecalculate_all_parents(frm) {\n\t\tfrappe.call({\n\t\t\tmethod: \"milestoneksa.api.project_tasks.recalculate_all_project_parents\",\n\t\t\targs: { project: frm.doc.name },\n\t\t\tfreeze: true,\n\t\t\tfreeze_message: __(\"Recalculating parent tasks...\"),\n\t\t\tcallback: (r) => {\n\t\t\t\tif (r.message) {\n\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\tmessage: __(`Updated ${r.message.updated_count} parent tasks`),\n\t\t\t\t\t\tindicator: \"green\"\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tfrm.events.load_project_tasks(frm);\n\t\t\t},\n\t\t});\n\t},\n\n\tload_project_tasks(frm) {\n\t\tconst field = frm.fields_dict.custom_project_tasks_html;\n\t\tif (!field) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst wrapper = field.$wrapper;\n\t\t\n\t\t// Reset selection state on every reload/render\n\t\tfrm.__selected_task_names = new Set();\n\t\twrapper.find(\"[data-role='select-all']\").prop(\"checked\", false).prop(\"indeterminate\", false);\n\n\t\tconst tableBody = wrapper.find(\"tbody\");\n\t\tconst emptyState = wrapper.find(\"[data-role='empty']\");\n\t\tconst loadingState = wrapper.find(\"[data-role='loading']\");\n\n\t\ttableBody.empty();\n\t\temptyState.addClass(\"d-none\");\n\t\tloadingState.removeClass(\"d-none\");\n\n\t\tconsole.log(\"[MKS][TASK TAB] Fetching tasks for project\", {\n\t\t\tproject: frm?.doc?.name,\n\t\t\tversion: frm?.events?.__mks_task_tab_version,\n\t\t});\n\t\t\n\t\tfrappe.call({\n\t\t\tmethod: \"milestoneksa.api.project_tasks.get_project_tasks\",\n\t\t\targs: { project: frm.doc.name },\n\t\t\tcallback: (r) => {\n\t\t\t\tloadingState.addClass(\"d-none\");\n\t\t\t\tconsole.log(\"[MKS][TASK TAB] get_project_tasks response\", {\n\t\t\t\t\tversion: frm?.events?.__mks_task_tab_version,\n\t\t\t\t\thas_message: !!r?.message,\n\t\t\t\t\ttask_count: r?.message?.tasks?.length,\n\t\t\t\t});\n\n\t\t\t\tif (!r || !r.message) {\n\t\t\t\t\tconsole.warn(\"[MKS][TASK TAB] No data returned\", {\n\t\t\t\t\t\tversion: frm?.events?.__mks_task_tab_version,\n\t\t\t\t\t});\n\t\t\t\t\temptyState.removeClass(\"d-none\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst { tasks = [], currency, status_options = [], priority_options = [] } = r.message;\n\n\t\t\t\tfrm.__project_task_meta = {\n\t\t\t\t\tcurrency,\n\t\t\t\t\tstatus_options,\n\t\t\t\t\tpriority_options,\n\t\t\t\t};\n\n\t\t\t\tif (!tasks.length) {\n\t\t\t\t\temptyState.removeClass(\"d-none\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tfrm.__project_tasks_data = tasks;\n\t\t\t\tfrm.events.render_task_hierarchy(frm, tasks, tableBody);\n\t\t\t\tfrm.events.update_select_all_checkbox(frm);\n\t\t\t},\n\t\t\terror: (err) => {\n\t\t\t\tconsole.error(\"Project Task Tab: API Error:\", err);\n\t\t\t\tloadingState.addClass(\"d-none\");\n\t\t\t\temptyState\n\t\t\t\t\t.removeClass(\"d-none\")\n\t\t\t\t\t.text(__(\"Unable to load tasks. Check console for errors.\"));\n\t\t\t\tfrappe.msgprint({\n\t\t\t\t\ttitle: __(\"Error Loading Tasks\"),\n\t\t\t\t\tmessage: __(\"Unable to load tasks. Please check browser console for details.\"),\n\t\t\t\t\tindicator: \"red\"\n\t\t\t\t});\n\t\t\t},\n\t\t});\n\t},\n\n\trender_task_hierarchy(frm, tasks, tableBody) {\n\t\t// Build parent-child map\n\t\tconst taskMap = {};\n\t\tconst rootTasks = [];\n\t\t\n\t\ttasks.forEach(t => {\n\t\t\ttaskMap[t.name] = { ...t, children: [], expanded: true };\n\t\t});\n\t\t\n\t\ttasks.forEach(t => {\n\t\t\tif (t.parent_task && taskMap[t.parent_task]) {\n\t\t\t\ttaskMap[t.parent_task].children.push(taskMap[t.name]);\n\t\t\t} else {\n\t\t\t\trootTasks.push(taskMap[t.name]);\n\t\t\t}\n\t\t});\n\t\t\n\t\t// Store task map in form for collapse/expand\n\t\tfrm.__task_hierarchy = taskMap;\n\t\t\n\t\t// Render recursively\n\t\tfunction renderTask(task, level = 0, parentExpanded = true) {\n\t\t\tconst row = frm.events.render_project_task_row(frm, task, level);\n\t\t\ttableBody.append(row);\n\t\t\t\n\t\t\t// Only show if parent is expanded\n\t\t\tif (!parentExpanded) {\n\t\t\t\trow.hide();\n\t\t\t}\n\t\t\t\n\t\t\t// Render children\n\t\t\tif (task.children && task.children.length > 0) {\n\t\t\t\ttask.children.forEach(child => {\n\t\t\t\t\trenderTask(child, level + 1, parentExpanded && task.expanded);\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\t\n\t\trootTasks.forEach(task => renderTask(task, 0, true));\n\t},\n\n\trender_project_task_row(frm, task, level = 0) {\n\t\tconst currency = frm.__project_task_meta?.currency;\n\t\tconst meta = frm.__project_task_meta || {};\n\t\tconst hasChildren = task.children && task.children.length > 0;\n\t\tconst indent = level * 20;\n\n\t\tconst toUserDate = (value) => (value ? frappe.datetime.str_to_user(value) : \"-\");\n\t\tconst toDays = (value) => (isNaN(value) || value === null ? \"-\" : `${value} ${__(\"days\")}`);\n\t\tconst toHours = (value) =>\n\t\t\tvalue === null || value === undefined ? \"-\" : frappe.format(value, { fieldtype: \"Float\", precision: 2 });\n\t\tconst toCurrency = (value) =>\n\t\t\tvalue === null || value === undefined\n\t\t\t\t? \"-\"\n\t\t\t\t: frappe.format(value, { fieldtype: \"Currency\", options: currency });\n\n\t\tconst row = $(`\n\t\t\t<tr data-task=\"${frappe.utils.escape_html(task.name)}\" \n\t\t\t    data-parent=\"${frappe.utils.escape_html(task.parent_task || '')}\"\n\t\t\t    data-level=\"${level}\"\n\t\t\t    class=\"${hasChildren ? 'table-primary parent-task' : 'child-task'}\">\n\t\t\t\t<td style=\"text-align: center; padding-left: 8px;\">\n\t\t\t\t\t<input type=\"checkbox\" class=\"task-checkbox task-row-checkbox\" data-task=\"${frappe.utils.escape_html(task.name)}\">\n\t\t\t\t</td>\n\t\t\t\t<td class=\"task-subject\" style=\"padding-left: ${indent + 10}px;\"></td>\n\t\t\t\t<td>${frappe.utils.escape_html(task.wbs || \"\")}</td>\n\t\t\t\t<td class=\"editable-cell\" data-field=\"status\">${frappe.utils.escape_html(task.status || \"\")}</td>\n\t\t\t\t<td class=\"editable-cell\" data-field=\"priority\">${frappe.utils.escape_html(task.priority || \"\")}</td>\n\t\t\t\t<td class=\"editable-cell\" data-field=\"exp_start_date\">${toUserDate(task.exp_start_date)}</td>\n\t\t\t\t<td class=\"editable-cell\" data-field=\"exp_end_date\">${toUserDate(task.exp_end_date)}</td>\n\t\t\t\t<td>${toDays(task.duration_days)}</td>\n\t\t\t\t<td class=\"editable-cell\" data-field=\"planned_hours\">${toHours(task.planned_hours)}</td>\n\t\t\t\t<td class=\"editable-cell\" data-field=\"custom_actual_start_date\" style=\"background-color: #f0f9ff;\">${toUserDate(task.custom_actual_start_date)}</td>\n\t\t\t\t<td class=\"editable-cell\" data-field=\"custom_actual_end_date\" style=\"background-color: #f0f9ff;\">${toUserDate(task.custom_actual_end_date)}</td>\n\t\t\t\t<td>${toDays(task.actual_duration_days)}</td>\n\t\t\t\t<td>${toHours(task.actual_hours)}</td>\n\t\t\t\t<td>${toCurrency(task.total_costing_amount)}</td>\n\t\t\t\t<td class=\"text-center\">\n\t\t\t\t\t<button class=\"btn btn-link btn-sm p-0 me-1\" data-role=\"add-child\" title=\"${__(\"Add Child Task\")}\">\n\t\t\t\t\t\t<svg class=\"icon icon-sm\"><use href=\"#icon-add\"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class=\"btn btn-link btn-sm p-0 me-1\" data-role=\"edit-task\" title=\"${__(\"Edit\")}\">\n\t\t\t\t\t\t<svg class=\"icon icon-sm\"><use href=\"#icon-edit\"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button class=\"btn btn-link btn-sm p-0 text-danger\" data-role=\"delete-task\" title=\"${__(\"Delete Task\")}\">\n\t\t\t\t\t\t<svg class=\"icon icon-sm\"><use href=\"#icon-delete\"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t`);\n\n\t\t// Subject cell with link and hierarchy indicator\n\t\tconst subjectCell = row.find(\".task-subject\");\n\t\t\n\t\tif (hasChildren) {\n\t\t\t// Collapsible triangle for parent tasks\n\t\t\tconst triangle = $(`\n\t\t\t\t<span class=\"collapse-triangle me-2\" style=\"cursor: pointer; user-select: none; font-size: 14px; display: inline-block; transition: transform 0.2s;\">\n\t\t\t\t\t‚ñº\n\t\t\t\t</span>\n\t\t\t`);\n\t\t\t\n\t\t\ttriangle.on(\"click\", (e) => {\n\t\t\t\te.stopPropagation();\n\t\t\t\tfrm.events.toggle_task_children(frm, task.name);\n\t\t\t});\n\t\t\t\n\t\t\tsubjectCell.append(triangle);\n\t\t} else {\n\t\t\t// Add spacing for alignment\n\t\t\tsubjectCell.append($('<span class=\"me-2\" style=\"width: 14px; display: inline-block;\"></span>'));\n\t\t}\n\t\t\n\t\tconst link = $(`<a class='${hasChildren ? \"fw-bold\" : \"\"}'>`)\n\t\t\t.text(task.subject || task.name)\n\t\t\t.on(\"click\", () => frappe.set_route(\"Form\", \"Task\", task.name));\n\t\tsubjectCell.append(link);\n\n\t\t// Make cells editable on click\n\t\trow.find(\".editable-cell\").on(\"click\", function() {\n\t\t\tfrm.events.make_cell_editable(frm, $(this), task, meta);\n\t\t});\n\n\t\t// Add child task button\n\t\trow.find(\"[data-role='add-child']\").on(\"click\", () => {\n\t\t\tfrm.events.open_project_task_dialog(frm, null, task.name);\n\t\t});\n\n\t\t// Edit task button\n\t\trow.find(\"[data-role='edit-task']\").on(\"click\", () => {\n\t\t\tfrm.events.open_project_task_dialog(frm, task);\n\t\t});\n\t\t\n\t\t// Delete task button\n\t\trow.find(\"[data-role='delete-task']\").on(\"click\", () => {\n\t\t\tfrm.events.delete_single_task(frm, task);\n\t\t});\n\t\t\n\t\t// Checkbox change handler\n\t\trow.find(\".task-row-checkbox\").on(\"change\", function() {\n\t\t\tconst isChecked = $(this).prop(\"checked\");\n\t\t\tconst taskName = $(this).data(\"task\");\n\t\t\t\n\t\t\tif (!frm.__selected_task_names) {\n\t\t\t\tfrm.__selected_task_names = new Set();\n\t\t\t}\n\t\t\t\n\t\t\tif (isChecked) {\n\t\t\t\tfrm.__selected_task_names.add(taskName);\n\t\t\t} else {\n\t\t\t\tfrm.__selected_task_names.delete(taskName);\n\t\t\t}\n\t\t\t\n\t\t\tif (isChecked) {\n\t\t\t\trow.addClass(\"task-row-selected\");\n\t\t\t} else {\n\t\t\t\trow.removeClass(\"task-row-selected\");\n\t\t\t}\n\t\t\tfrm.events.update_select_all_checkbox(frm);\n\t\t});\n\n\t\treturn row;\n\t},\n\n\ttoggle_task_children(frm, taskName) {\n\t\tconst taskMap = frm.__task_hierarchy || {};\n\t\tconst task = taskMap[taskName];\n\t\t\n\t\tif (!task || !task.children || task.children.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\t\n\t\t// Toggle expanded state\n\t\ttask.expanded = !task.expanded;\n\t\t\n\t\t// Find the row and triangle\n\t\tconst row = $(`tr[data-task=\"${taskName}\"]`);\n\t\tconst triangle = row.find(\".collapse-triangle\");\n\t\t\n\t\t// Toggle triangle class and rotation\n\t\tif (task.expanded) {\n\t\t\ttriangle.removeClass(\"collapsed\");\n\t\t\trow.removeClass(\"collapsed\");\n\t\t} else {\n\t\t\ttriangle.addClass(\"collapsed\");\n\t\t\trow.addClass(\"collapsed\");\n\t\t}\n\t\t\n\t\t// Toggle all descendant rows with animation\n\t\tfunction toggleDescendants(parentTask, show) {\n\t\t\tparentTask.children.forEach(child => {\n\t\t\t\tconst childRow = $(`tr[data-task=\"${child.name}\"]`);\n\t\t\t\t\n\t\t\t\tif (show && task.expanded) {\n\t\t\t\t\tchildRow.removeClass(\"hidden-by-collapse\").fadeIn(200);\n\t\t\t\t\t// If this child is also expanded and has children, show them too\n\t\t\t\t\tif (child.expanded && child.children && child.children.length > 0) {\n\t\t\t\t\t\ttoggleDescendants(child, true);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tchildRow.addClass(\"hidden-by-collapse\").fadeOut(200);\n\t\t\t\t\t// Hide all descendants regardless\n\t\t\t\t\tif (child.children && child.children.length > 0) {\n\t\t\t\t\t\ttoggleDescendants(child, false);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\t\n\t\ttoggleDescendants(task, task.expanded);\n\t\t\n\t\t// Show feedback\n\t\tconst childCount = task.children.length;\n\t\tconst action = task.expanded ? \"expanded\" : \"collapsed\";\n\t\tfrappe.show_alert({\n\t\t\tmessage: `${action === \"expanded\" ? \"‚ñº\" : \"‚ñ∂\"} ${childCount} child task${childCount > 1 ? \"s\" : \"\"} ${action}`,\n\t\t\tindicator: \"blue\"\n\t\t}, 2);\n\t},\n\n\tmake_cell_editable(frm, cell, task, meta) {\n\t\t// Prevent multiple edit sessions\n\t\tif (cell.data(\"editing\")) return;\n\t\tcell.data(\"editing\", true);\n\t\t\n\t\tconst field = cell.data(\"field\");\n\t\tconst currentValue = task[field];\n\t\tconst originalHtml = cell.html();\n\t\t\n\t\tcell.empty().css(\"padding\", \"2px\");\n\t\t\n\t\tlet input;\n\t\tif (field === \"status\") {\n\t\t\tinput = $(`<select class=\"form-control form-control-sm\" style=\"width: 100%;\"></select>`);\n\t\t\t(meta.status_options || []).forEach(opt => {\n\t\t\t\tinput.append($(\"<option>\").val(opt).text(opt).prop(\"selected\", opt === currentValue));\n\t\t\t});\n\t\t} else if (field === \"priority\") {\n\t\t\tinput = $(`<select class=\"form-control form-control-sm\" style=\"width: 100%;\"></select>`);\n\t\t\t(meta.priority_options || []).forEach(opt => {\n\t\t\t\tinput.append($(\"<option>\").val(opt).text(opt).prop(\"selected\", opt === currentValue));\n\t\t\t});\n\t\t} else if (field === \"exp_start_date\" || field === \"exp_end_date\" || field === \"custom_actual_start_date\" || field === \"custom_actual_end_date\") {\n\t\t\tinput = $(`<input type=\"date\" class=\"form-control form-control-sm\" style=\"width: 100%;\">`);\n\t\t\tif (currentValue) {\n\t\t\t\tinput.val(frappe.datetime.str_to_user(currentValue, \"yyyy-mm-dd\"));\n\t\t\t}\n\t\t} else if (field === \"planned_hours\") {\n\t\t\tinput = $(`<input type=\"number\" step=\"0.5\" class=\"form-control form-control-sm\" style=\"width: 100%;\">`);\n\t\t\tinput.val(currentValue || \"\");\n\t\t}\n\t\t\n\t\tcell.append(input);\n\t\t\n\t\t// Focus after a brief delay to ensure rendering\n\t\tsetTimeout(() => {\n\t\t\tinput.focus();\n\t\t\tif (input.is(\"select\")) {\n\t\t\t\tinput.click(); // Open dropdown\n\t\t\t}\n\t\t}, 50);\n\t\t\n\t\tlet saved = false;\n\t\t\n\t\tconst saveValue = () => {\n\t\t\tif (saved) return;\n\t\t\tsaved = true;\n\t\t\t\n\t\t\tconst newValue = input.val();\n\t\t\t\n\t\t\t// Restore cell appearance\n\t\t\tcell.data(\"editing\", false);\n\t\t\tcell.css(\"padding\", \"\");\n\t\t\t\n\t\t\tif (newValue && newValue !== currentValue) {\n\t\t\t\tconst updates = {};\n\t\t\t\tupdates[field] = newValue;\n\t\t\t\tcell.html(`<span class=\"text-muted\"><i>Saving...</i></span>`);\n\t\t\t\tfrm.events.quick_update_task(frm, task.name, updates);\n\t\t\t} else {\n\t\t\t\t// Just restore original\n\t\t\t\tcell.html(originalHtml);\n\t\t\t}\n\t\t};\n\t\t\n\t\tconst cancelEdit = () => {\n\t\t\tif (saved) return;\n\t\t\tsaved = true;\n\t\t\tcell.data(\"editing\", false);\n\t\t\tcell.css(\"padding\", \"\");\n\t\t\tcell.html(originalHtml);\n\t\t};\n\t\t\n\t\t// For select, save on change\n\t\tif (input.is(\"select\")) {\n\t\t\tinput.on(\"change\", () => {\n\t\t\t\tsaveValue();\n\t\t\t});\n\t\t\tinput.on(\"blur\", () => {\n\t\t\t\tsetTimeout(cancelEdit, 100);\n\t\t\t});\n\t\t} else {\n\t\t\t// For inputs, save on blur or enter\n\t\t\tinput.on(\"blur\", () => {\n\t\t\t\tsetTimeout(saveValue, 100);\n\t\t\t});\n\t\t\tinput.on(\"keydown\", (e) => {\n\t\t\t\tif (e.which === 13) { // Enter\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tsaveValue();\n\t\t\t\t} else if (e.which === 27) { // Escape\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tcancelEdit();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\t\n\t\t// Prevent click from bubbling\n\t\tinput.on(\"click\", (e) => {\n\t\t\te.stopPropagation();\n\t\t});\n\t},\n\n\tquick_update_task(frm, taskName, updates) {\n\t\tfrappe.call({\n\t\t\tmethod: \"milestoneksa.api.project_tasks.update_project_task\",\n\t\t\targs: {\n\t\t\t\ttask_name: taskName,\n\t\t\t\tupdates: updates,\n\t\t\t},\n\t\t\tfreeze: false,\n\t\t\tcallback: () => {\n\t\t\t\tfrappe.show_alert({ message: __(\"Task updated\"), indicator: \"green\" });\n\t\t\t\tfrm.events.load_project_tasks(frm);\n\t\t\t},\n\t\t});\n\t},\n\n\topen_project_task_dialog(frm, task = null, parentTask = null) {\n\t\tconst isEdit = Boolean(task);\n\t\tconst meta = frm.__project_task_meta || {};\n\t\tconst statusOptions = meta.status_options || [\"Open\", \"Working\", \"Pending Review\", \"Overdue\", \"Completed\", \"Cancelled\"];\n\t\tconst priorityOptions = meta.priority_options || [\"Low\", \"Medium\", \"High\", \"Urgent\"];\n\n\t\tconst dialog = new frappe.ui.Dialog({\n\t\t\ttitle: isEdit ? __(\"Update Task\") : (parentTask ? __(\"Add Child Task\") : __(\"Add Task\")),\n\t\t\tfields: [\n\t\t\t\t{ fieldname: \"subject\", label: __(\"Subject\"), fieldtype: \"Data\", reqd: 1 },\n\t\t\t\t{ \n\t\t\t\t\tfieldname: \"is_group\", \n\t\t\t\t\tlabel: __(\"Is Group (Parent Task)\"), \n\t\t\t\t\tfieldtype: \"Check\",\n\t\t\t\t\tdefault: 0,\n\t\t\t\t\tdescription: __(\"Check this if this task will have child tasks\")\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tfieldname: \"status\",\n\t\t\t\t\tlabel: __(\"Status\"),\n\t\t\t\t\tfieldtype: \"Select\",\n\t\t\t\t\toptions: statusOptions.join(\"\\n\"),\n\t\t\t\t\tdefault: \"Open\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tfieldname: \"priority\",\n\t\t\t\t\tlabel: __(\"Priority\"),\n\t\t\t\t\tfieldtype: \"Select\",\n\t\t\t\t\toptions: priorityOptions.join(\"\\n\"),\n\t\t\t\t\tdefault: \"Medium\",\n\t\t\t\t},\n\t\t\t\t{ fieldname: \"col_break_1\", fieldtype: \"Column Break\" },\n\t\t\t\t{ fieldname: \"exp_start_date\", label: __(\"Planned Start\"), fieldtype: \"Date\" },\n\t\t\t\t{ fieldname: \"exp_end_date\", label: __(\"Planned Finish\"), fieldtype: \"Date\" },\n\t\t\t\t{ fieldname: \"planned_hours\", label: __(\"Planned Hours\"), fieldtype: \"Float\" },\n\t\t\t\t{ fieldname: \"section_actual\", label: __(\"Actual Dates\"), fieldtype: \"Section Break\" },\n\t\t\t\t{ fieldname: \"custom_actual_start_date\", label: __(\"Actual Start Date\"), fieldtype: \"Date\" },\n\t\t\t\t{ fieldname: \"col_break_2\", fieldtype: \"Column Break\" },\n\t\t\t\t{ fieldname: \"custom_actual_end_date\", label: __(\"Actual End Date\"), fieldtype: \"Date\" },\n\t\t\t\t{ fieldname: \"section_more\", label: __(\"More Details\"), fieldtype: \"Section Break\", collapsible: 1 },\n\t\t\t\t{\n\t\t\t\t\tfieldname: \"parent_task\",\n\t\t\t\t\tlabel: __(\"Parent Task\"),\n\t\t\t\t\tfieldtype: \"Link\",\n\t\t\t\t\toptions: \"Task\",\n\t\t\t\t\tdescription: __(\"Optional: link this task beneath another task.\"),\n\t\t\t\t\tdefault: parentTask || \"\",\n\t\t\t\t\tread_only: parentTask ? 1 : 0,\n\t\t\t\t\tdepends_on: \"eval:!doc.is_group\",\n\t\t\t\t},\n\t\t\t\t{ fieldname: \"description\", label: __(\"Description\"), fieldtype: \"Small Text\" },\n\t\t\t],\n\t\t\tprimary_action_label: isEdit ? __(\"Update\") : __(\"Create\"),\n\t\t\tprimary_action(values) {\n\t\t\t\tif (!values.subject) {\n\t\t\t\t\tfrappe.msgprint(__(\"Subject is required.\"));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (isEdit) {\n\t\t\t\t\tfrm.events.submit_task_update(frm, task.name, values, dialog);\n\t\t\t\t} else {\n\t\t\t\t\tfrm.events.submit_task_create(frm, values, dialog);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\n\t\tif (isEdit) {\n\t\t\tdialog.set_values({\n\t\t\t\tsubject: task.subject,\n\t\t\t\tis_group: task.is_group || 0,\n\t\t\t\tstatus: task.status,\n\t\t\t\tpriority: task.priority,\n\t\t\t\texp_start_date: task.exp_start_date,\n\t\t\t\texp_end_date: task.exp_end_date,\n\t\t\t\tplanned_hours: task.planned_hours,\n\t\t\t\tcustom_actual_start_date: task.custom_actual_start_date,\n\t\t\t\tcustom_actual_end_date: task.custom_actual_end_date,\n\t\t\t\tparent_task: task.parent_task,\n\t\t\t\tdescription: task.description,\n\t\t\t});\n\t\t\t\n\t\t\t// Add delete button when editing\n\t\t\tdialog.add_custom_action(__(\"Delete\"), () => {\n\t\t\t\tfrm.events.delete_single_task(frm, task, dialog);\n\t\t\t}, \"btn-danger\");\n\t\t}\n\n\t\tdialog.show();\n\t},\n\n\tsubmit_task_create(frm, values, dialog) {\n\t\tfrappe.call({\n\t\t\tmethod: \"milestoneksa.api.project_tasks.create_project_task\",\n\t\t\targs: {\n\t\t\t\tproject: frm.doc.name,\n\t\t\t\ttask: values,\n\t\t\t},\n\t\t\tfreeze: true,\n\t\t\tfreeze_message: __(\"Creating task...\"),\n\t\t\tcallback: () => {\n\t\t\t\tdialog.hide();\n\t\t\t\tfrappe.show_alert({ message: __(\"Task created\"), indicator: \"green\" });\n\t\t\t\tfrm.events.load_project_tasks(frm);\n\t\t\t},\n\t\t});\n\t},\n\n\tsubmit_task_update(frm, taskName, values, dialog) {\n\t\tfrappe.call({\n\t\t\tmethod: \"milestoneksa.api.project_tasks.update_project_task\",\n\t\t\targs: {\n\t\t\t\ttask_name: taskName,\n\t\t\t\tupdates: values,\n\t\t\t},\n\t\t\tfreeze: true,\n\t\t\tfreeze_message: __(\"Updating task...\"),\n\t\t\tcallback: () => {\n\t\t\t\tdialog.hide();\n\t\t\t\tfrappe.show_alert({ message: __(\"Task updated\"), indicator: \"green\" });\n\t\t\t\tfrm.events.load_project_tasks(frm);\n\t\t\t},\n\t\t});\n\t},\n\t\n\tdelete_selected_tasks(frm) {\n\t\tconst field = frm.fields_dict.custom_project_tasks_html;\n\t\tif (!field) return;\n\t\t\n\t\tconst wrapper = field.$wrapper;\n\t\t\n\t\t// SAFETY: never delete unless user explicitly selected rows\n\t\tconst selected = Array.from(frm.__selected_task_names || []);\n\t\tif (!selected.length) {\n\t\t\tfrappe.msgprint({\n\t\t\t\ttitle: __(\"No Tasks Selected\"),\n\t\t\t\tmessage: __(\"Please select at least one task to delete.\"),\n\t\t\t\tindicator: \"orange\"\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\t\tconst taskNames = selected;\n\t\tconst taskCount = taskNames.length;\n\t\t\n\t\tfrappe.confirm(\n\t\t\t__(\n\t\t\t\t\"Are you sure you want to FORCE delete {0} selected task(s) AND all connected tasks (children + dependent tasks)? This action cannot be undone.\",\n\t\t\t\t[taskCount]\n\t\t\t),\n\t\t\t() => {\n\t\t\t\t// User confirmed\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: \"milestoneksa.api.project_tasks.delete_project_tasks\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\ttask_names: taskNames,\n\t\t\t\t\t\tforce: 1,\n\t\t\t\t\t\tdelete_connected: 1,\n\t\t\t\t\t},\n\t\t\t\t\tfreeze: true,\n\t\t\t\t\tfreeze_message: __(\"Deleting tasks...\"),\n\t\t\t\t\tcallback: (r) => {\n\t\t\t\t\t\tconst deleted_count = r?.message?.deleted_count ?? taskCount;\n\t\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\t\tmessage: __(\"{0} task(s) deleted successfully (including connected tasks)\", [deleted_count]),\n\t\t\t\t\t\t\tindicator: \"green\"\n\t\t\t\t\t\t});\n\t\t\t\t\t\tfrm.events.load_project_tasks(frm);\n\t\t\t\t\t},\n\t\t\t\t\terror: (err) => {\n\t\t\t\t\t\tconsole.error(\"Error deleting tasks:\", err);\n\t\t\t\t\t\tfrappe.msgprint({\n\t\t\t\t\t\t\ttitle: __(\"Error\"),\n\t\t\t\t\t\t\tmessage: __(\"Failed to delete tasks. Please check console for details.\"),\n\t\t\t\t\t\t\tindicator: \"red\"\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\t\t\t() => {\n\t\t\t\t// User cancelled - do nothing\n\t\t\t}\n\t\t);\n\t},\n\t\n\tdelete_single_task(frm, task, dialog = null) {\n\t\tif (!task || !task.name) {\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tconst taskName = task.name;\n\t\tconst taskSubject = task.subject || taskName;\n\t\t\n\t\tfrappe.confirm(\n\t\t\t__(\n\t\t\t\t\"Are you sure you want to FORCE delete the task '{0}' AND all connected tasks (children + dependent tasks)? This action cannot be undone.\",\n\t\t\t\t[taskSubject]\n\t\t\t),\n\t\t\t() => {\n\t\t\t\t// User confirmed\n\t\t\t\tif (dialog) {\n\t\t\t\t\tdialog.hide();\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: \"milestoneksa.api.project_tasks.delete_project_tasks\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\ttask_names: [taskName],\n\t\t\t\t\t\tforce: 1,\n\t\t\t\t\t\tdelete_connected: 1,\n\t\t\t\t\t},\n\t\t\t\t\tfreeze: true,\n\t\t\t\t\tfreeze_message: __(\"Deleting task...\"),\n\t\t\t\t\tcallback: (r) => {\n\t\t\t\t\t\tconst deleted_count = r?.message?.deleted_count ?? 1;\n\t\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\t\tmessage: __(\"Deleted {0} task(s) (including connected tasks)\", [deleted_count]),\n\t\t\t\t\t\t\tindicator: \"green\"\n\t\t\t\t\t\t});\n\t\t\t\t\t\tfrm.events.load_project_tasks(frm);\n\t\t\t\t\t},\n\t\t\t\t\terror: (err) => {\n\t\t\t\t\t\tconsole.error(\"Error deleting task:\", err);\n\t\t\t\t\t\tfrappe.msgprint({\n\t\t\t\t\t\t\ttitle: __(\"Error\"),\n\t\t\t\t\t\t\tmessage: __(\"Failed to delete task. Please check console for details.\"),\n\t\t\t\t\t\t\tindicator: \"red\"\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\t\t\t() => {\n\t\t\t\t// User cancelled - do nothing\n\t\t\t}\n\t\t);\n\t},\n\t\n\tupdate_select_all_checkbox(frm) {\n\t\tconst field = frm.fields_dict.custom_project_tasks_html;\n\t\tif (!field) return;\n\t\t\n\t\tconst wrapper = field.$wrapper;\n\t\tconst allCheckboxes = wrapper.find(\".task-row-checkbox\");\n\t\tconst checkedCheckboxes = wrapper.find(\".task-row-checkbox:checked\");\n\t\tconst selectAllCheckbox = wrapper.find(\"[data-role='select-all']\");\n\t\t\n\t\t// Keep Set in sync with DOM state (extra safety)\n\t\tfrm.__selected_task_names = new Set(\n\t\t\tcheckedCheckboxes.map(function() { return $(this).data(\"task\"); }).get()\n\t\t);\n\t\t\n\t\tif (allCheckboxes.length === 0) {\n\t\t\tselectAllCheckbox.prop(\"checked\", false);\n\t\t\treturn;\n\t\t}\n\t\t\n\t\t// Update select all checkbox state\n\t\tif (checkedCheckboxes.length === 0) {\n\t\t\tselectAllCheckbox.prop(\"indeterminate\", false);\n\t\t\tselectAllCheckbox.prop(\"checked\", false);\n\t\t} else if (checkedCheckboxes.length === allCheckboxes.length) {\n\t\t\tselectAllCheckbox.prop(\"indeterminate\", false);\n\t\t\tselectAllCheckbox.prop(\"checked\", true);\n\t\t} else {\n\t\t\tselectAllCheckbox.prop(\"indeterminate\", true);\n\t\t}\n\t},\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-08-04 14:27:50.016300",
  "module": null,
  "name": "po script",
  "script": "frappe.ui.form.on('Purchase Order', {\n\trefresh(frm) {\n\t\tfrm.add_custom_button(\n        __('Populate From Items'),\n        function() {\n          if (!frm.doc.items || frm.doc.items.length === 0) {\n            frappe.msgprint(__('No items found to generate schedule.'));\n            return;\n          }\n          // Clear existing schedule rows\n          frm.clear_table('payment_schedule');\n\n          // Sequential monthly schedule based on posting date\n          let current = frm.doc.posting_date || frm.doc.transaction_date;\n          frm.doc.items.forEach(item => {\n            const row = frm.add_child('payment_schedule');\n            // Start date for this task\n            row.start_date = current;\n            // Calculate due_date one month after start_date\n            const nextDue = frappe.datetime.add_months(current, 1);\n            row.due_date = nextDue;\n            row.payment_amount = flt(item.qty) * flt(item.rate);\n            row.description = `${item.item_code} ‚Äì ${item.description || item.item_name}`;\n            // Next task starts when this one ends\n            current = nextDue;\n          });\n\n          // Refresh table and notify\n          frm.refresh_field('payment_schedule');\n          frappe.msgprint(__('Payment Schedule populated sequentially from posting date.'));\n        }\n      );\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee",
  "enabled": 1,
  "modified": "2025-08-19 11:17:43.067990",
  "module": null,
  "name": "Employee Code",
  "script": "frappe.ui.form.on('Employee', {\n\trefresh(frm) {\n\t\trecalc_residence_total(frm); // keep UI consistent on load\n\t},\n\n\t// Fired when a row is added to the child table\n\tcustom_residence_costs_add(frm) {\n\t\trecalc_residence_total(frm);\n\t}\n});\n\n// Trigger on edits inside the child table rows\nfrappe.ui.form.on('Residence Costs', {\n\tamount(frm, cdt, cdn) {\n\t\trecalc_residence_total(frm);\n\t},\n\ttransaction_date(frm, cdt, cdn) {\n\t\t// optional: only if you want any change to prompt recompute\n\t\trecalc_residence_total(frm);\n\t},\n\tresidence_costs(frm, cdt, cdn) {\n\t\t// optional: same note as above\n\t\trecalc_residence_total(frm);\n\t},\n\t// Fired when a row is removed from the child table\n\tcustom_residence_costs_remove(frm, cdt, cdn) {\n\t\trecalc_residence_total(frm);\n\t}\n});\n\nfunction recalc_residence_total(frm) {\n\tlet total = 0.0;\n\t(frm.doc.custom_residence_costs || []).forEach(r => {\n\t\ttotal += flt(r.amount || 0);\n\t});\n\tfrm.set_value('custom_total_cost', total);\n\tfrm.refresh_field('custom_total_cost');\n}\n\n// frappe.utils.flt helper for consistency with backend rounding\nfunction flt(val, precision) {\n\tconst p = (typeof precision === 'number') ? precision : 2;\n\tlet n = parseFloat(val);\n\tif (isNaN(n)) n = 0;\n\treturn parseFloat(n.toFixed(p));\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Payroll Entry",
  "enabled": 1,
  "modified": "2025-08-26 14:23:25.542355",
  "module": null,
  "name": "payroll print",
  "script": "frappe.ui.form.on('Payroll Entry', {\n  refresh(frm) {\n    // Only show on Submitted (change to !== 0 if you also want Draft)\n    if (frm.doc.docstatus !== 1) return;\n\n    // --- Helper: POST to an endpoint and open in a new tab (with CSRF) ---\n    const open_post = (url, params = {}) => {\n      const form = document.createElement('form');\n      form.method = 'POST';\n      form.action = url;\n      form.target = '_blank';\n\n      // include CSRF token so Frappe accepts the POST\n      const fields = { csrf_token: frappe.csrf_token, ...params };\n      Object.entries(fields).forEach(([k, v]) => {\n        const input = document.createElement('input');\n        input.type = 'hidden';\n        input.name = k;\n        input.value = typeof v === 'string' ? v : JSON.stringify(v);\n        form.appendChild(input);\n      });\n\n      document.body.appendChild(form);\n      form.submit();\n      form.remove();\n    };\n\n    const group = __('Cairo PDF');\n\n    // Build employee list once\n    const employees = (frm.doc.employees || []).map(r => r.employee).filter(Boolean);\n\n    // A) Custom report PDF (your HTML/CSS via milestoneksa.api.pdf.download_salary_report_pdf)\n    frm.add_custom_button(__('Salary Register (Cairo PDF)'), () => {\n      const filters = {\n        company: frm.doc.company,\n        from_date: frm.doc.start_date || frm.doc.from_date,\n        to_date: frm.doc.end_date || frm.doc.to_date,\n        payroll_frequency: frm.doc.payroll_frequency,\n        payroll_entry: frm.doc.name,\n        employee_list: employees, // server will post-filter rows if needed\n      };\n\n      open_post('/api/method/milestoneksa.api.pdf.download_salary_report_pdf', {\n        report_name: 'Salary Register', // change if you want another report\n        filters: JSON.stringify(filters),\n      });\n    }, group);\n\n    // B) Merge all Salary Slips for this Payroll Entry using your Cairo print format\n    frm.add_custom_button(__('All Salary Slips (Cairo Print)'), () => {\n      open_post('/api/method/frappe.utils.print_format.download_multi_pdf', {\n        doctype: 'Salary Slip',\n        filters: JSON.stringify([['payroll_entry', '=', frm.doc.name]]),\n        print_format: 'Salary Slip - Cairo',\n        no_letterhead: 0,\n        orientation: 'Portrait',\n      });\n    }, group);\n  },\n});\n",
  "view": "Form"
 }
]